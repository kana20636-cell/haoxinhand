<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>好心手作全功能系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #F3F4F6; color: #374151; font-family: sans-serif; display: flex; }
        .sidebar { width: 200px; height: 100vh; position: fixed; left: 0; top: 0; background: white; border-right: 1px solid #E5E7EB; display: flex; flex-direction: column; }
        .nav-btn { width: 100%; text-align: left; padding: 1rem; font-weight: 600; color: #6B7280; border-right: 4px solid transparent; }
        .nav-btn.active { background-color: #F9FAFB; color: #8E9775; border-right-color: #8E9775; }
        main { margin-left: 200px; padding: 40px; width: calc(100% - 200px); min-height: 100vh; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 6px solid #E5E7EB; }
        .hidden { display: none; }
        input, select { border: 1px solid #D1D5DB; padding: 8px; border-radius: 6px; width: 100%; margin-top: 4px; }
        label { font-size: 11px; font-weight: bold; color: #9CA3AF; text-transform: uppercase; }
        .btn-primary { background: #8E9775; color: white; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; margin-top: 15px; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .order-urgent { border-left-color: #EF4444; }
        .order-warning { border-left-color: #F59E0B; }
        .order-safe { border-left-color: #10B981; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-6 text-center"><h1 class="text-lg font-black text-[#8E9775]">好心手作</h1></div>
        <nav class="flex-1">
            <button onclick="showTab('orders')" id="btn-orders" class="nav-btn active">訂單管理</button>
            <button onclick="showTab('inventory')" id="btn-inventory" class="nav-btn">材料進貨</button>
            <button onclick="showTab('items')" id="btn-items" class="nav-btn">配方成本</button>
            <button onclick="showTab('customers')" id="btn-customers" class="nav-btn">顧客維護</button>
            <button onclick="showTab('stats')" id="btn-stats" class="nav-btn">銷售排行</button>
        </nav>
    </aside>

    <main>
        <section id="tab-orders" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">訂單追蹤</h2>
            <div class="card !border-l-0">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label>顧客姓名</label><input type="text" id="custName"></div>
                    <div><label>交貨日期</label><input type="date" id="orderDate"></div>
                    <div><label>來源</label><select id="orderSource"><option>LINE</option><option>FB/IG</option><option>現場</option></select></div>
                    <div class="col-span-2"><label>選擇產品</label><select id="orderItemSelect"></select></div>
                    <div class="col-span-2"><label>實收金額</label><input type="number" id="orderPrice"></div>
                </div>
                <button onclick="addNewOrder()" class="btn-primary">建立訂單</button>
            </div>
            <div id="orderListDisplay" class="space-y-3"></div>
        </section>

        <section id="tab-inventory" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">材料庫存</h2>
            <div class="card !border-l-slate-500">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label>材料名稱</label><input type="text" id="invName"></div>
                    <div><label>數量</label><input type="number" id="invQty"></div>
                    <div><label>單位</label><input type="text" id="invUnit" placeholder="g"></div>
                    <div class="col-span-2"><label>總價</label><input type="number" id="invPrice"></div>
                </div>
                <button onclick="addInventory()" class="btn-primary" style="background:#475569">入庫材料</button>
            </div>
            <div id="inventoryListDisplay" class="grid grid-cols-2 gap-2"></div>
        </section>

        <section id="tab-items" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">配方成本設定</h2>
            <div class="card !border-l-[#8E9775]">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label>產品名稱</label><input type="text" id="itemName"></div>
                    <div class="col-span-2"><label>建議售價</label><input type="number" id="itemPrice"></div>
                    <div class="col-span-2 bg-gray-50 p-3 rounded"><label>配方組成</label><div id="recipeBuilder" class="mt-2 space-y-1"></div></div>
                </div>
                <button onclick="addItem()" class="btn-primary">儲存產品配方</button>
            </div>
            <div id="itemsListDisplay" class="space-y-2"></div>
        </section>

        <section id="tab-customers" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">顧客維護</h2>
            <div id="customerListDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="tab-stats" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">銷售分析排行</h2>
            <div id="statsSummary" class="grid grid-cols-3 gap-4 mb-6"></div>
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                <table class="w-full text-left">
                    <thead><tr class="text-gray-400 text-xs border-b">
                        <th class="pb-3">產品名稱</th><th class="pb-3">銷售次數</th><th class="pb-3">總營收</th><th class="pb-3">預估利潤</th>
                    </tr></thead>
                    <tbody id="statsTableBody" class="text-sm"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk",
            authDomain: "haoxin-44098.firebaseapp.com",
            databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "haoxin-44098",
            storageBucket: "haoxin-44098.firebasestorage.app",
            messagingSenderId: "878734507134",
            appId: "1:878734507134:web:91598cf6816d401e66ac2f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let rawMaterials = {};
        let productList = {};

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        }

        function getWorkDays(d) {
            if(!d) return 0;
            const target = new Date(d); const today = new Date(); today.setHours(0,0,0,0);
            if(target < today) return -1;
            let count = 0; let cur = new Date(today);
            while(cur < target) { cur.setDate(cur.getDate() + 1); if(cur.getDay() !== 0 && cur.getDay() !== 6) count++; }
            return count;
        }

        // --- 功能模組 ---
        function addInventory() {
            const name = document.getElementById('invName').value;
            const qty = parseFloat(document.getElementById('invQty').value || 0);
            const price = parseFloat(document.getElementById('invPrice').value || 0);
            if(name && qty > 0) db.ref('inventory').push({ name, qty, unit: document.getElementById('invUnit').value, price, unitPrice: price/qty });
        }

        db.ref('inventory').on('value', snap => {
            const list = document.getElementById('inventoryListDisplay');
            const builder = document.getElementById('recipeBuilder');
            list.innerHTML = ""; builder.innerHTML = "";
            rawMaterials = snap.val() || {};
            Object.keys(rawMaterials).forEach(id => {
                const v = rawMaterials[id];
                list.innerHTML += `<div class="bg-white p-2 border rounded-lg text-xs flex justify-between"><span>${v.name}</span><b>$${v.unitPrice.toFixed(1)} <button onclick="del('inventory','${id}')" class="ml-1 text-red-200">×</button></b></div>`;
                builder.innerHTML += `<div class="flex items-center gap-2 text-xs"><input type="checkbox" class="m-check" value="${id}"><span class="w-16">${v.name}</span><input type="number" class="w-12 border m-qty" placeholder="量">${v.unit}</div>`;
            });
        });

        function addItem() {
            const name = document.getElementById('itemName').value;
            let totalCost = 0;
            const recipe = [];
            document.querySelectorAll('.m-check:checked').forEach(el => {
                const qty = parseFloat(el.parentElement.querySelector('.m-qty').value || 0);
                const cost = rawMaterials[el.value].unitPrice * qty;
                totalCost += cost;
                recipe.push({ name: rawMaterials[el.value].name, qty, cost });
            });
            if(name) db.ref('items').push({ name, totalCost, price: parseFloat(document.getElementById('itemPrice').value || 0), recipe });
        }

        db.ref('items').on('value', snap => {
            const list = document.getElementById('itemsListDisplay');
            const sel = document.getElementById('orderItemSelect');
            list.innerHTML = ""; sel.innerHTML = '<option value="">請選擇</option>';
            productList = snap.val() || {};
            Object.keys(productList).forEach(id => {
                const i = productList[id];
                list.innerHTML += `<div class="bg-white p-3 border rounded flex justify-between text-sm"><span><b>${i.name}</b><br><small class="text-gray-400">成本: $${i.totalCost.toFixed(1)}</small></span><button onclick="del('items','${id}')" class="text-red-200">×</button></div>`;
                sel.innerHTML += `<option value="${id}">${i.name} ($${i.price})</option>`;
            });
        });

        function addNewOrder() {
            const itemId = document.getElementById('orderItemSelect').value;
            const d = {
                cust: document.getElementById('custName').value,
                date: document.getElementById('orderDate').value,
                itemId: itemId,
                itemName: productList[itemId] ? productList[itemId].name : "未知產品",
                price: parseFloat(document.getElementById('orderPrice').value || 0),
                cost: productList[itemId] ? productList[itemId].totalCost : 0,
                source: document.getElementById('orderSource').value,
                status: '製作中'
            };
            if(d.cust && d.date) db.ref('orders').push(d);
        }

        db.ref('orders').on('value', snap => {
            const list = document.getElementById('orderListDisplay');
            const statsTable = document.getElementById('statsTableBody');
            const statsSummary = document.getElementById('statsSummary');
            const custDisplay = document.getElementById('customerListDisplay');
            
            list.innerHTML = ""; statsTable.innerHTML = ""; custDisplay.innerHTML = "";
            const data = snap.val() || {};
            
            let totalSales = 0, totalProfit = 0, productStats = {}, customers = {};

            Object.keys(data).sort((a,b) => data[a].date.localeCompare(data[b].date)).forEach(id => {
                const o = data[id];
                const w = getWorkDays(o.date);
                
                // 統計邏輯
                totalSales += o.price;
                totalProfit += (o.price - (o.cost || 0));
                productStats[o.itemName] = productStats[o.itemName] || { count: 0, revenue: 0, profit: 0 };
                productStats[o.itemName].count++;
                productStats[o.itemName].revenue += o.price;
                productStats[o.itemName].profit += (o.price - (o.cost || 0));

                customers[o.cust] = (customers[o.cust] || 0) + o.price;

                // 訂單列表渲染
                let cls = w < 0 || w <= 3 ? 'order-urgent' : (w <= 7 ? 'order-warning' : 'order-safe');
                if(o.status === '已完成') cls = '!border-l-gray-300 opacity-60';
                
                list.innerHTML += `<div class="card ${cls} flex justify-between items-center">
                    <div><span class="tag ${o.status=='已完成'?'bg-gray-100':'bg-amber-100 text-amber-600'}">${o.status}</span>
                    <b class="ml-2">${o.cust}</b> <small class="text-gray-400">${o.date}</small>
                    <p class="text-xs text-gray-500 mt-1">${o.itemName} (${o.source})</p></div>
                    <div class="text-right"><b>$${o.price}</b><br>
                    <select onchange="db.ref('orders/${id}').update({status:this.value})" class="text-[10px] w-20"><option value="製作中" ${o.status=='製作中'?'selected':''}>製作中</option><option value="已完成" ${o.status=='已完成'?'selected':''}>已完成</option></select>
                    <button onclick="del('orders','${id}')" class="text-xs text-red-200 ml-1">×</button></div></div>`;
            });

            // 渲染統計排行
            statsSummary.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-sm text-center"><h6>總營收</h6><b class="text-xl">$${totalSales}</b></div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center"><h6>總利潤</h6><b class="text-xl text-green-500">$${totalProfit.toFixed(0)}</b></div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center"><h6>訂單數</h6><b class="text-xl text-blue-500">${Object.keys(data).length}</b></div>`;
            
            Object.keys(productStats).sort((a,b) => productStats[b].count - productStats[a].count).forEach(name => {
                const s = productStats[name];
                statsTable.innerHTML += `<tr class="border-b"><td class="py-3">${name}</td><td>${s.count} 次</td><td>$${s.revenue}</td><td class="text-green-600">$${s.profit.toFixed(0)}</td></tr>`;
            });

            // 渲染顧客維護
            Object.keys(customers).forEach(name => {
                custDisplay.innerHTML += `<div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm">
                    <span><b>${name}</b></span>
                    <div class="text-right"><small class="text-gray-400">累計消費</small><br><b class="text-[#8E9775]">$${customers[name]}</b></div>
                </div>`;
            });
        });

        function del(p, id) { if(confirm("確定刪除？")) db.ref(p+'/'+id).remove(); }
        window.onload = () => showTab('orders');
    </script>
</body>
</html>

