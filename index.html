<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>好心手作 - 全功能維護系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #F9FAFB; color: #374151; font-family: sans-serif; display: flex; }
        .sidebar { width: 220px; height: 100vh; position: fixed; left: 0; top: 0; background: white; border-right: 1px solid #E5E7EB; z-index: 100; }
        .nav-btn { width: 100%; text-align: left; padding: 1rem 1.5rem; font-weight: 600; color: #6B7280; border-right: 4px solid transparent; }
        .nav-btn.active { background-color: #F3F4F6; color: #8E9775; border-right-color: #8E9775; }
        main { margin-left: 220px; padding: 30px; width: calc(100% - 220px); }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        input, select { border: 1px solid #D1D5DB; padding: 10px; border-radius: 8px; width: 100%; margin-top: 4px; }
        label { font-size: 12px; font-weight: bold; color: #6B7280; }
        .btn-primary { background: #8E9775; color: white; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .status-making { background: #FEF3C7; color: #D97706; }
        .status-shipped { background: #DBEAFE; color: #2563EB; }
        .status-done { background: #D1FAE5; color: #059669; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-8 text-center"><h1 class="text-xl font-black text-[#8E9775]">好心手作</h1></div>
        <nav>
            <button onclick="showTab('orders')" id="btn-orders" class="nav-btn active">訂單管理</button>
            <button onclick="showTab('inventory')" id="btn-inventory" class="nav-btn">材料庫存</button>
            <button onclick="showTab('items')" id="btn-items" class="nav-btn">品項配方維護</button>
            <button onclick="showTab('customers')" id="btn-customers" class="nav-btn">顧客維護</button>
        </nav>
    </aside>

    <main>
        <section id="tab-orders" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">訂單追蹤</h2>
            <div class="card">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label>顧客姓名</label><input type="text" id="custName"></div>
                    <div><label>交貨日期</label><input type="date" id="orderDate"></div>
                    <div><label>產品選擇</label><select id="orderItemSelect"></select></div>
                </div>
                <button onclick="addNewOrder()" class="btn-primary">建立新訂單</button>
            </div>
            <div id="orderListDisplay" class="space-y-3"></div>
        </section>

        <section id="tab-inventory" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">材料庫存入庫</h2>
            <div class="card">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label>材料名稱</label><input type="text" id="invName"></div>
                    <div><label>數量</label><input type="number" id="invQty"></div>
                    <div><label>單位</label><input type="text" id="invUnit" placeholder="g"></div>
                    <div class="col-span-2"><label>總進價</label><input type="number" id="invPrice"></div>
                </div>
                <button onclick="addInventory()" class="btn-primary" style="background:#4B5563">確認入庫</button>
            </div>
            <div id="inventoryListDisplay" class="grid grid-cols-2 gap-3 mt-4"></div>
        </section>

        <section id="tab-items" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">品項維護與分類</h2>
            
            <div class="card bg-gray-50 border-dashed border-2 border-gray-200">
                <label>新增自定義分類 (如: 巴斯克、磅蛋糕)</label>
                <div class="flex gap-2 mt-2">
                    <input type="text" id="newCatName" placeholder="輸入分類名稱" class="flex-1">
                    <button onclick="addCategory()" class="bg-gray-600 text-white px-4 rounded-lg text-sm">新增分類</button>
                </div>
                <div id="catTags" class="flex flex-wrap gap-2 mt-3"></div>
            </div>

            <div class="card">
                <div class="grid grid-cols-2 gap-4">
                    <div><label>產品分類</label><select id="itemCategorySelect"></select></div>
                    <div><label>產品名稱</label><input type="text" id="itemName"></div>
                    <div class="col-span-2"><label>售價</label><input type="number" id="itemPrice"></div>
                    <div class="col-span-2 bg-gray-100 p-4 rounded-lg">
                        <label class="text-[#8E9775] block mb-2 font-bold text-sm">配方內容勾選</label>
                        <div id="recipeBuilder" class="space-y-2"></div>
                    </div>
                </div>
                <button onclick="addItem()" class="btn-primary">儲存品項</button>
            </div>
            <div id="itemsListDisplay" class="space-y-4"></div>
        </section>

        <section id="tab-customers" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">顧客累積消費</h2>
            <div id="customerListDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk",
            authDomain: "haoxin-44098.firebaseapp.com",
            databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "haoxin-44098",
            storageBucket: "haoxin-44098.firebasestorage.app",
            messagingSenderId: "878734507134",
            appId: "1:878734507134:web:91598cf6816d401e66ac2f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let rawMaterials = {};
        let productList = {};
        let categories = [];

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        }

        // --- 分類管理 ---
        function addCategory() {
            const name = document.getElementById('newCatName').value;
            if(name) {
                db.ref('categories').push(name).then(() => {
                    document.getElementById('newCatName').value = '';
                });
            }
        }

        db.ref('categories').on('value', snap => {
            const tags = document.getElementById('catTags');
            const sel = document.getElementById('itemCategorySelect');
            tags.innerHTML = ""; sel.innerHTML = "";
            const data = snap.val() || {};
            categories = Object.values(data);
            Object.keys(data).forEach(id => {
                const name = data[id];
                tags.innerHTML += `<span class="bg-gray-200 px-2 py-1 rounded text-xs">${name} <button onclick="del('categories','${id}')" class="text-red-400">×</button></span>`;
                sel.innerHTML += `<option value="${name}">${name}</option>`;
            });
        });

        // --- 材料與品項與訂單 (其餘邏輯同上，但加強穩定性) ---
        function addInventory() {
            const name = document.getElementById('invName').value;
            const qty = parseFloat(document.getElementById('invQty').value);
            const price = parseFloat(document.getElementById('invPrice').value);
            const unit = document.getElementById('invUnit').value || 'g';
            if (name && qty) {
                db.ref('inventory').push({ name, qty, unit, price, unitPrice: price/qty })
                .then(() => { document.getElementById('invName').value=''; });
            }
        }

        db.ref('inventory').on('value', snap => {
            const list = document.getElementById('inventoryListDisplay');
            const builder = document.getElementById('recipeBuilder');
            list.innerHTML = ""; builder.innerHTML = "";
            rawMaterials = snap.val() || {};
            Object.keys(rawMaterials).forEach(id => {
                const m = rawMaterials[id];
                list.innerHTML += `<div class="bg-white p-2 border rounded shadow-sm text-sm flex justify-between">
                    <span>${m.name}</span> <button onclick="del('inventory','${id}')" class="text-red-300">×</button></div>`;
                builder.innerHTML += `<div class="flex items-center gap-2 text-xs">
                    <input type="checkbox" class="m-check" value="${id}"> <span>${m.name}</span>
                    <input type="number" class="m-qty w-16 border rounded p-1"> ${m.unit}</div>`;
            });
        });

        function addItem() {
            const name = document.getElementById('itemName').value;
            const category = document.getElementById('itemCategorySelect').value;
            const price = parseFloat(document.getElementById('itemPrice').value || 0);
            let totalCost = 0;
            const recipe = [];
            document.querySelectorAll('.m-check:checked').forEach(el => {
                const mid = el.value;
                const qty = parseFloat(el.parentElement.querySelector('.m-qty').value || 0);
                const cost = rawMaterials[mid].unitPrice * qty;
                totalCost += cost;
                recipe.push({ name: rawMaterials[mid].name, qty, cost });
            });
            if (name && category) {
                db.ref('items').push({ name, category, price, totalCost, recipe })
                .then(() => { alert('品項已存'); document.getElementById('itemName').value=''; });
            }
        }

        db.ref('items').on('value', snap => {
            const list = document.getElementById('itemsListDisplay');
            const sel = document.getElementById('orderItemSelect');
            list.innerHTML = ""; sel.innerHTML = '<option value="">請選擇</option>';
            productList = snap.val() || {};
            Object.keys(productList).forEach(id => {
                const p = productList[id];
                list.innerHTML += `<div class="bg-white p-3 border rounded-lg flex justify-between mb-2">
                    <span><b>[${p.category}]</b> ${p.name}</span>
                    <button onclick="del('items','${id}')" class="text-red-300">×</button></div>`;
                sel.innerHTML += `<option value="${id}">${p.category} - ${p.name}</option>`;
            });
        });

        function addNewOrder() {
            const pid = document.getElementById('orderItemSelect').value;
            const cust = document.getElementById('custName').value;
            const date = document.getElementById('orderDate').value;
            if (pid && cust && date) {
                const p = productList[pid];
                db.ref('orders').push({
                    cust, date, itemName: p.name, price: p.price, status: '製作中'
                });
            }
        }

        db.ref('orders').on('value', snap => {
            const list = document.getElementById('orderListDisplay');
            const custDisp = document.getElementById('customerListDisplay');
            list.innerHTML = ""; custDisp.innerHTML = "";
            const data = snap.val() || {};
            const cStats = {};

            Object.keys(data).sort((a,b) => data[a].date.localeCompare(data[b].date)).forEach(id => {
                const o = data[id];
                cStats[o.cust] = (cStats[o.cust] || 0) + o.price;
                const statusCls = o.status === "製作中" ? "status-making" : (o.status === "已出貨" ? "status-shipped" : "status-done");
                
                list.innerHTML += `<div class="card flex justify-between border-l-8 ${o.status=='已完成'?'border-gray-200 opacity-60':'border-[#8E9775]'}">
                    <div><span class="px-2 py-1 rounded text-[10px] font-bold ${statusCls}">${o.status}</span>
                    <b class="ml-2">${o.cust}</b> <p class="text-xs text-gray-500 mt-1">${o.itemName} (${o.date})</p></div>
                    <div class="text-right">
                        <select onchange="db.ref('orders/${id}').update({status:this.value})" class="text-xs p-1">
                            <option value="製作中" ${o.status=='製作中'?'selected':''}>製作中</option>
                            <option value="已出貨" ${o.status=='已出貨'?'selected':''}>已出貨</option>
                            <option value="已完成" ${o.status=='已完成'?'selected':''}>已完成</option>
                        </select>
                        <button onclick="del('orders','${id}')" class="text-xs text-red-200 block mt-1 ml-auto">刪</button>
                    </div></div>`;
            });

            Object.keys(cStats).forEach(c => {
                custDisp.innerHTML += `<div class="bg-white p-4 rounded-xl border flex justify-between"><b>${c}</b><span>$${cStats[c]}</span></div>`;
            });
        });

        function del(p, id) { if(confirm("確定刪除？")) db.ref(p+'/'+id).remove(); }
        window.onload = () => showTab('orders');
    </script>
</body>
</html>
