<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>好心手作管理系統</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        body { background-color: #F8F9FA; color: #4A4A4A; font-family: "PingFang TC", sans-serif; padding-top: env(safe-area-inset-top); }
        .sidebar { transition: all 0.3s ease; width: 260px; min-width: 260px; height: 100vh; position: sticky; top: 0; background: white; display: flex; flex-direction: column; border-right: 1px solid #EEE; }
        .sidebar.collapsed { width: 0; min-width: 0; overflow: hidden; border: none; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 1.5rem; } 
        .nav-btn { width: 100%; text-align: left; padding: 0.8rem 1rem; border-radius: 0.8rem; margin-bottom: 0.4rem; font-weight: bold; }
        .nav-btn.active { background-color: #8E9775; color: white; }
        .card { background: white; border-radius: 1.2rem; padding: 1.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        input, select { border: 1px solid #DDD; padding: 0.6rem; border-radius: 0.6rem; width: 100%; margin-bottom: 0.5rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="flex">
    <aside id="sidebar" class="sidebar shadow-lg z-50">
        <div class="sidebar-content">
            <h1 class="text-xl font-black mb-6 text-[#8E9775] tracking-widest px-2">好心手作</h1>
            <nav id="nav-list">
                <button onclick="showTab('orders')" class="nav-btn active">訂單管理</button>
                <button onclick="showTab('inventory')" class="nav-btn">進貨管理</button>
                <button onclick="showTab('items')" class="nav-btn">品項管理</button>
                <button onclick="showTab('customers')" class="nav-btn">顧客維護</button>
                <button onclick="showTab('rank')" class="nav-btn">銷售排行</button>
                <button onclick="showTab('report')" class="nav-btn">銷售報表</button>
            </nav>
        </div>
    </aside>
    <main class="flex-1 p-4 md:p-8">
        <button id="toggleBtn" onclick="toggleSidebar()" class="mb-4 bg-white border px-4 py-2 rounded-lg shadow-sm font-bold text-[#8E9775]">關閉選單</button>

        <section id="orders" class="tab-content active">
            <h2 class="text-xl font-bold mb-4">訂單管理</h2>
            <div class="card bg-[#F3F5F0]">
                <h3 class="font-bold mb-2 text-[#8E9775]">＋ 建立新訂單</h3>
                <input type="date" id="orderDate">
                <input type="text" id="custName" placeholder="顧客姓名">
                <select id="orderItemSelect"><option value="">選擇品項</option></select>
                <input type="number" id="orderPrice" placeholder="金額">
                <select id="orderSource">
                    <option value="社群">來源：社群</option>
                    <option value="LINE">來源：LINE</option>
                    <option value="FB/IG">來源：FB/IG</option>
                </select>
                <button onclick="addNewOrder()" class="w-full bg-[#8E9775] text-white py-2 rounded-lg font-bold">儲存訂單</button>
            </div>
            <div id="orderList" class="space-y-2"></div>
        </section>

        <section id="items" class="tab-content">
            <h2 class="text-xl font-bold mb-4">品項維護</h2>
            <div class="card bg-[#F3F5F0]">
                <h3 class="font-bold mb-2 text-[#8E9775]">1. 分類設定</h3>
                <div class="flex gap-2"><input type="text" id="newCat" placeholder="新分類"><button onclick="addCat()" class="bg-[#8E9775] text-white px-4 py-2 rounded-lg">新增</button></div>
                <div id="catList" class="flex flex-wrap gap-2 mt-2"></div>
            </div>
            <div class="card">
                <h3 class="font-bold mb-2 text-[#8E9775]">2. 品項明細編輯</h3>
                <select id="itemCat"><option value="">選擇分類</option></select>
                <input type="text" id="itemName" placeholder="品項名稱">
                <div class="flex gap-2">
                    <input type="number" id="itemQty" placeholder="數量">
                    <input type="text" id="itemUnit" placeholder="單位 (如:盒,片,顆)">
                </div>
                <input type="number" id="itemPrice" placeholder="建議單價">
                <button onclick="addItem()" class="w-full bg-[#8E9775] text-white py-2 rounded-lg font-bold">新增品項</button>
                <div id="itemsList" class="mt-4"></div>
            </div>
        </section>

        <section id="inventory" class="tab-content"><h2 class="text-xl font-bold">進貨管理</h2><div id="inventoryList"></div></section>
        <section id="customers" class="tab-content"><h2 class="text-xl font-bold">顧客維護</h2><div id="custList"></div></section>
        <section id="rank" class="tab-content"><h2 class="text-xl font-bold">銷售排行</h2><div id="rankList"></div></section>
        <section id="report" class="tab-content"><h2 class="text-xl font-bold">銷售報表</h2><div id="reportDisp"></div></section>
    </main>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk",
            authDomain: "haoxin-44098.firebaseapp.com",
            databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "haoxin-44098",
            storageBucket: "haoxin-44098.firebasestorage.app",
            messagingSenderId: "878734507134",
            appId: "1:878734507134:web:91598cf6816d401e66ac2f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const btn = document.getElementById('toggleBtn');
            sb.classList.toggle('collapsed');
            btn.innerText = sb.classList.contains('collapsed') ? "開啟選單" : "關閉選單";
        }
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(event) event.currentTarget.classList.add('active');
        }

        // --- 品項與分類 ---
        function addCat() { const n = document.getElementById('newCat').value; if(n) db.ref('categories').push(n); document.getElementById('newCat').value=''; }
        db.ref('categories').on('value', snap => {
            const list = document.getElementById('catList'); const sel = document.getElementById('itemCat');
            list.innerHTML = ""; sel.innerHTML = '<option value="">選擇分類</option>';
            if(snap.val()) Object.keys(snap.val()).forEach(id => {
                const n = snap.val()[id];
                list.innerHTML += `<span class="bg-white border px-2 py-1 rounded text-sm">${n} <button onclick="del('categories','${id}')" class="text-red-400">×</button></span>`;
                sel.innerHTML += `<option value="${n}">${n}</option>`;
            });
        });

        function addItem() {
            const c = document.getElementById('itemCat').value; 
            const n = document.getElementById('itemName').value; 
            const q = document.getElementById('itemQty').value;
            const u = document.getElementById('itemUnit').value;
            const p = document.getElementById('itemPrice').value;
            if(c && n) db.ref('items').push({ cat: c, name: n, qty: q, unit: u, price: p });
            // 清空輸入框
            document.getElementById('itemName').value = ''; document.getElementById('itemQty').value = ''; document.getElementById('itemUnit').value = ''; document.getElementById('itemPrice').value = '';
        }

        db.ref('items').on('value', snap => {
            const list = document.getElementById('itemsList'); const oSel = document.getElementById('orderItemSelect');
            list.innerHTML = ""; oSel.innerHTML = '<option value="">選擇品項</option>';
            if(snap.val()) Object.keys(snap.val()).forEach(id => {
                const i = snap.val()[id];
                const spec = i.qty ? `${i.qty}${i.unit}` : i.unit; // 組合規格文字
                list.innerHTML += `<div class="flex justify-between border-b py-2 text-sm"><span>[${i.cat}] ${i.name} (${spec}) - $${i.price}</span>
                    <div><button onclick="editI('${id}','${i.name}',${i.price})" class="text-blue-500 mr-2">編輯</button><button onclick="del('items','${id}')" class="text-red-400">刪除</button></div></div>`;
                oSel.innerHTML += `<option value="${i.name} (${spec})">${i.name} (${spec})</option>`;
            });
        });

        function editI(id, n, p) { 
            const nn = prompt("名稱", n); const np = prompt("價格", p); 
            if(nn && np) db.ref('items/'+id).update({ name: nn, price: np }); 
        }

        // --- 訂單 ---
        function addNewOrder() {
            const d = { 
                date: document.getElementById('orderDate').value, 
                cust: document.getElementById('custName').value, 
                item: document.getElementById('orderItemSelect').value, 
                price: parseFloat(document.getElementById('orderPrice').value || 0),
                source: document.getElementById('orderSource').value
            };
            if(d.cust) db.ref('orders').push(d);
            alert('訂單儲存成功！');
        }

        db.ref('orders').on('value', snap => {
            const list = document.getElementById('orderList'); list.innerHTML = "";
            if(snap.val()) Object.keys(snap.val()).forEach(id => {
                const o = snap.val()[id];
                list.innerHTML += `<div class="card py-3 flex justify-between items-center text-sm"><div><b>${o.cust}</b> - ${o.item}<br><small>${o.date} (${o.source})</small></div>
                    <div class="font-bold text-[#8E9775]">$${o.price} <button onclick="del('orders','${id}')" class="text-red-400 ml-2">×</button></div></div>`;
            });
        });

        function del(p, id) { if(confirm("確定刪除？")) db.ref(p+'/'+id).remove(); }
    </script>
</body>
</html>
