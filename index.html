<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>好心手作 - 系統完整修復版</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #F3F4F6; color: #374151; font-family: sans-serif; display: flex; }
        .sidebar { width: 220px; height: 100vh; position: fixed; left: 0; top: 0; background: white; border-right: 1px solid #E5E7EB; display: flex; flex-direction: column; z-index: 100; }
        .nav-btn { width: 100%; text-align: left; padding: 1rem 1.5rem; font-weight: 600; color: #6B7280; border-right: 4px solid transparent; transition: 0.2s; }
        .nav-btn.active { background-color: #F9FAFB; color: #8E9775; border-right-color: #8E9775; }
        main { margin-left: 220px; padding: 40px; width: calc(100% - 220px); min-height: 100vh; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; border-left: 6px solid #E5E7EB; }
        .hidden { display: none !important; }
        input, select { border: 1px solid #D1D5DB; padding: 8px; border-radius: 6px; width: 100%; margin-top: 4px; font-size: 14px; }
        label { font-size: 11px; font-weight: bold; color: #9CA3AF; }
        .btn-primary { background: #8E9775; color: white; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; margin-top: 15px; cursor: pointer; }
        .btn-primary:hover { opacity: 0.9; }
        .tag { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .order-urgent { border-left-color: #EF4444; }
        .order-warning { border-left-color: #F59E0B; }
        .order-safe { border-left-color: #10B981; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-8 text-center"><h1 class="text-xl font-black text-[#8E9775]">好心手作</h1></div>
        <nav class="flex-1">
            <button onclick="showTab('orders')" id="btn-orders" class="nav-btn active">訂單管理</button>
            <button onclick="showTab('inventory')" id="btn-inventory" class="nav-btn">材料庫存</button>
            <button onclick="showTab('items')" id="btn-items" class="nav-btn">品項與配方</button>
            <button onclick="showTab('customers')" id="btn-customers" class="nav-btn">顧客維護</button>
            <button onclick="showTab('stats')" id="btn-stats" class="nav-btn">銷售排行</button>
        </nav>
    </aside>

    <main>
        <section id="tab-orders" class="tab-content">
            <h2 class="text-2xl font-bold mb-6">訂單追蹤</h2>
            <div class="card !border-l-0">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label>顧客姓名</label><input type="text" id="custName"></div>
                    <div><label>交貨日期</label><input type="date" id="orderDate"></div>
                    <div><label>來源</label><select id="orderSource"><option>LINE</option><option>FB/IG</option><option>社群</option><option>現場</option></select></div>
                    <div class="col-span-2"><label>選擇產品 (需先在品項頁面新增)</label><select id="orderItemSelect"></select></div>
                    <div class="col-span-2"><label>實收金額</label><input type="number" id="orderPrice" placeholder="0"></div>
                </div>
                <button onclick="addNewOrder()" class="btn-primary">建立新訂單</button>
            </div>
            <div id="orderListDisplay" class="space-y-3"></div>
        </section>

        <section id="tab-inventory" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">材料管理 (進貨入庫)</h2>
            <div class="card !border-l-slate-600">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label>材料名稱</label><input type="text" id="invName" placeholder="例如：法國奶油"></div>
                    <div><label>進貨數量</label><input type="number" id="invQty" placeholder="1000"></div>
                    <div><label>單位</label><input type="text" id="invUnit" placeholder="g"></div>
                    <div class="col-span-2"><label>進貨總價</label><input type="number" id="invPrice" placeholder="0"></div>
                </div>
                <button onclick="addInventory()" class="btn-primary" style="background:#475569">存入原料庫</button>
            </div>
            <div class="mt-4"><label>目前庫存原料：</label></div>
            <div id="inventoryListDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2"></div>
        </section>

        <section id="tab-items" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">產品維護與成本計算</h2>
            <div class="card !border-l-[#8E9775]">
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2"><label>產品名稱</label><input type="text" id="itemName" placeholder="例如：原味巴斯克"></div>
                    <div class="col-span-2"><label>預設售價</label><input type="number" id="itemPrice" placeholder="0"></div>
                    <div class="col-span-2 bg-gray-50 p-4 rounded-lg mt-2">
                        <label class="text-[#8E9775] text-sm mb-2 block">配方用料設定 (請先去材料庫存進貨)</label>
                        <div id="recipeBuilder" class="space-y-2">
                            </div>
                    </div>
                </div>
                <button onclick="addItem()" class="btn-primary">儲存產品品項</button>
            </div>
            <hr class="my-6">
            <label>現有產品清單：</label>
            <div id="itemsListDisplay" class="space-y-3 mt-2"></div>
        </section>

        <section id="tab-customers" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">顧客維護</h2>
            <div id="customerListDisplay" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="tab-stats" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">銷售數據排行榜</h2>
            <div id="statsSummary" class="grid grid-cols-3 gap-4 mb-6"></div>
            <div class="bg-white p-6 rounded-xl border">
                <table class="w-full text-left">
                    <thead><tr class="text-gray-400 text-xs border-b"><th class="pb-3">產品名稱</th><th class="pb-3">銷售量</th><th class="pb-3">總營收</th><th class="pb-3">毛利估算</th></tr></thead>
                    <tbody id="statsTableBody" class="text-sm"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // --- Firebase 初始化 ---
        const firebaseConfig = {
            apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk",
            authDomain: "haoxin-44098.firebaseapp.com",
            databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "haoxin-44098",
            storageBucket: "haoxin-44098.firebasestorage.app",
            messagingSenderId: "878734507134",
            appId: "1:878734507134:web:91598cf6816d401e66ac2f"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let rawMaterials = {};
        let productList = {};

        // --- 分頁切換 ---
        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        }

        // --- 1. 材料進貨邏輯 ---
        function addInventory() {
            const name = document.getElementById('invName').value;
            const qty = parseFloat(document.getElementById('invQty').value || 0);
            const price = parseFloat(document.getElementById('invPrice').value || 0);
            const unit = document.getElementById('invUnit').value || 'g';
            if(name && qty > 0) {
                db.ref('inventory').push({ name, qty, unit, price, unitPrice: price/qty })
                  .then(() => {
                      alert('材料已成功入庫！');
                      document.getElementById('invName').value = '';
                      document.getElementById('invQty').value = '';
                      document.getElementById('invPrice').value = '';
                  });
            } else { alert('請填寫完整的材料資訊'); }
        }

        db.ref('inventory').on('value', snap => {
            const list = document.getElementById('inventoryListDisplay');
            const builder = document.getElementById('recipeBuilder');
            list.innerHTML = ""; builder.innerHTML = "";
            rawMaterials = snap.val() || {};
            
            if(Object.keys(rawMaterials).length === 0) {
                builder.innerHTML = '<p class="text-xs text-gray-400 italic">尚未有材料庫存，請先至「材料庫存」進貨。</p>';
            }

            Object.keys(rawMaterials).forEach(id => {
                const v = rawMaterials[id];
                list.innerHTML += `<div class="bg-white p-3 border rounded-lg text-sm flex justify-between items-center shadow-sm">
                    <span>${v.name} <small class="text-gray-400">($${v.unitPrice.toFixed(2)}/${v.unit})</small></span>
                    <button onclick="del('inventory','${id}')" class="text-red-300 hover:text-red-500 font-bold">×</button>
                </div>`;
                
                builder.innerHTML += `
                    <div class="flex items-center gap-2 text-sm p-1 border-b border-gray-100">
                        <input type="checkbox" class="m-check w-4 h-4" value="${id}">
                        <span class="w-24 font-medium">${v.name}</span>
                        <input type="number" class="m-qty w-20 border rounded p-1" placeholder="用量">
                        <span class="text-gray-400">${v.unit}</span>
                    </div>`;
            });
        });

        // --- 2. 品項與配方邏輯 ---
        function addItem() {
            const name = document.getElementById('itemName').value;
            const price = parseFloat(document.getElementById('itemPrice').value || 0);
            let totalCost = 0;
            const recipe = [];

            document.querySelectorAll('.m-check:checked').forEach(el => {
                const matId = el.value;
                const useQty = parseFloat(el.parentElement.querySelector('.m-qty').value || 0);
                if(useQty > 0) {
                    const cost = rawMaterials[matId].unitPrice * useQty;
                    totalCost += cost;
                    recipe.push({ name: rawMaterials[matId].name, qty: useQty, cost: cost });
                }
            });

            if(name && recipe.length > 0) {
                db.ref('items').push({ name, price, totalCost, recipe })
                  .then(() => {
                      alert('品項及配方儲存成功！');
                      document.getElementById('itemName').value = '';
                      document.getElementById('itemPrice').value = '';
                  });
            } else { alert('請輸入產品名稱並勾選至少一項材料用量'); }
        }

        db.ref('items').on('value', snap => {
            const list = document.getElementById('itemsListDisplay');
            const sel = document.getElementById('orderItemSelect');
            list.innerHTML = ""; sel.innerHTML = '<option value="">請選擇產品</option>';
            productList = snap.val() || {};
            
            Object.keys(productList).forEach(id => {
                const i = productList[id];
                list.innerHTML += `<div class="bg-white p-4 border rounded-xl flex justify-between items-center shadow-sm">
                    <div><b>${i.name}</b><br><small class="text-gray-400">總成本: $${i.totalCost.toFixed(1)} / 建議售價: $${i.price}</small></div>
                    <div class="text-right">
                        <span class="text-green-600 font-bold text-sm">利潤 $${(i.price - i.totalCost).toFixed(1)}</span>
                        <button onclick="del('items','${id}')" class="ml-4 text-red-300 font-bold">×</button>
                    </div>
                </div>`;
                sel.innerHTML += `<option value="${id}">${i.name} (售價$${i.price})</option>`;
            });
        });

        // --- 3. 訂單邏輯 ---
        function addNewOrder() {
            const itemId = document.getElementById('orderItemSelect').value;
            const cust = document.getElementById('custName').value;
            const date = document.getElementById('orderDate').value;
            const price = parseFloat(document.getElementById('orderPrice').value || 0);

            if(cust && date && itemId) {
                const product = productList[itemId];
                db.ref('orders').push({
                    cust, date, itemId,
                    itemName: product.name,
                    price: price || product.price, // 若未填則用預設售價
                    cost: product.totalCost,
                    source: document.getElementById('orderSource').value,
                    status: '製作中'
                }).then(() => {
                    document.getElementById('custName').value = '';
                });
            } else { alert('請填寫顧客姓名、日期並選擇產品'); }
        }

        // --- 數據同步與分析 (排行、顧客) ---
        db.ref('orders').on('value', snap => {
            const list = document.getElementById('orderListDisplay');
            const statsTable = document.getElementById('statsTableBody');
            const statsSum = document.getElementById('statsSummary');
            const custDisp = document.getElementById('customerListDisplay');
            
            list.innerHTML = ""; statsTable.innerHTML = ""; custDisp.innerHTML = "";
            const data = snap.val() || {};
            
            let totalSales = 0, totalProfit = 0, pStats = {}, cStats = {};

            Object.keys(data).sort((a,b) => data[a].date.localeCompare(data[b].date)).forEach(id => {
                const o = data[id];
                totalSales += o.price;
                totalProfit += (o.price - (o.cost || 0));
                
                // 排行統計
                pStats[o.itemName] = pStats[o.itemName] || { count: 0, rev: 0, profit: 0 };
                pStats[o.itemName].count++;
                pStats[o.itemName].rev += o.price;
                pStats[o.itemName].profit += (o.price - (o.cost || 0));

                // 顧客統計
                cStats[o.cust] = (cStats[o.cust] || 0) + o.price;

                // 訂單 UI
                const today = new Date(); today.setHours(0,0,0,0);
                const target = new Date(o.date);
                const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                let cls = diff <= 3 ? 'order-urgent' : (diff <= 7 ? 'order-warning' : 'order-safe');
                if(o.status === '已完成') cls = '!border-l-gray-300 opacity-60';

                list.innerHTML += `<div class="card ${cls} flex justify-between items-center">
                    <div><span class="tag ${o.status=='已完成'?'bg-gray-100':'bg-amber-100 text-amber-600'}">${o.status}</span>
                    <b class="ml-2">${o.cust}</b> <small class="text-gray-400">${o.date}</small>
                    <p class="text-xs text-gray-500 mt-1">${o.itemName} / 來源: ${o.source}</p></div>
                    <div class="text-right"><b>$${o.price}</b><br>
                    <select onchange="db.ref('orders/${id}').update({status:this.value})" class="text-[10px] w-20 mt-1"><option value="製作中" ${o.status=='製作中'?'selected':''}>製作中</option><option value="已完成" ${o.status=='已完成'?'selected':''}>已完成</option></select>
                    <button onclick="del('orders','${id}')" class="text-xs text-red-200 ml-2">刪除</button></div></div>`;
            });

            // 銷售看板
            statsSum.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><h6>總營收</h6><b class="text-xl">$${totalSales.toLocaleString()}</b></div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><h6>估計利潤</h6><b class="text-xl text-green-500">$${totalProfit.toLocaleString(undefined,{maximumFractionDigits:0})}</b></div>
                <div class="bg-white p-4 rounded-xl shadow-sm text-center border"><h6>總訂單數</h6><b class="text-xl text-blue-500">${Object.keys(data).length}</b></div>`;
            
            Object.keys(pStats).sort((a,b) => pStats[b].count - pStats[a].count).forEach(name => {
                const s = pStats[name];
                statsTable.innerHTML += `<tr class="border-b"><td class="py-3">${name}</td><td>${s.count}</td><td>$${s.rev}</td><td class="text-green-600">+$${s.profit.toFixed(0)}</td></tr>`;
            });

            // 顧客清單
            Object.keys(cStats).forEach(name => {
                custDisp.innerHTML += `<div class="bg-white p-4 rounded-xl border flex justify-between items-center shadow-sm">
                    <span><b>${name}</b></span>
                    <div class="text-right"><small class="text-gray-400">累計消費</small><br><b class="text-[#8E9775] text-lg">$${cStats[name]}</b></div>
                </div>`;
            });
        });

        function del(p, id) { if(confirm("確定要刪除這筆資料嗎？")) db.ref(p+'/'+id).remove(); }
        window.onload = () => showTab('orders');
    </script>
</body>
</html>
