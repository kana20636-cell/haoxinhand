<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好心手作 - 專業營運管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background-color: #F3F4F6; display: flex; font-family: sans-serif; min-height: 100vh; }
        .sidebar { width: 220px; background: white; border-right: 1px solid #E5E7EB; position: fixed; height: 100%; z-index: 50; }
        .nav-btn { width: 100%; text-align: left; padding: 1rem 1.5rem; font-weight: 600; color: #4B5563; transition: 0.3s; }
        .nav-btn.active { background: #F9FAFB; color: #8E9775; border-right: 4px solid #8E9775; }
        main { margin-left: 220px; padding: 25px; width: calc(100% - 220px); }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none !important; }
        input, select { border: 1px solid #D1D5DB; padding: 8px 12px; border-radius: 8px; width: 100%; margin-top: 4px; outline: none; }
        input:focus { border-color: #8E9775; }
        .btn-primary { background: #8E9775; color: white; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; border: none; transition: 0.3s; }
        .btn-primary:hover { background: #7A8463; }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .urgent { color: #EF4444; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-8 text-xl font-black text-[#8E9775]">好心手作</div>
        <nav>
            <button onclick="showTab('orders')" id="btn-orders" class="nav-btn active">訂單追蹤</button>
            <button onclick="showTab('inventory')" id="btn-inventory" class="nav-btn">材料進貨</button>
            <button onclick="showTab('items')" id="btn-items" class="nav-btn">品項配方</button>
            <button onclick="showTab('stats')" id="btn-stats" class="nav-btn">銷售報表</button>
        </nav>
    </aside>

    <main>
        <section id="tab-orders" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">訂單追蹤</h2>
            <div class="card">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="text-xs">顧客姓名</label><input type="text" id="o_cust"></div>
                    <div><label class="text-xs">交貨日期</label><input type="date" id="o_date"></div>
                    <div><label class="text-xs">來源</label><select id="o_source"><option>LINE</option><option>IG/FB</option><option>現場</option></select></div>
                    <div><label class="text-xs">選擇產品</label><select id="o_item_sel" onchange="autoFillPrice()"></select></div>
                    <div class="col-span-2"><label class="text-xs">實收金額</label><input type="number" id="o_price"></div>
                    <div class="col-span-2 flex items-end"><button onclick="saveOrder()" class="btn-primary w-full">建立訂單</button></div>
                </div>
            </div>
            <div id="list_orders" class="space-y-3"></div>
        </section>

        <section id="tab-inventory" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">材料進貨與庫存</h2>
            <div class="card">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <div class="col-span-2"><label class="text-xs">材料名稱</label><input type="text" id="i_name"></div>
                    <div><label class="text-xs">進貨日期</label><input type="date" id="i_date"></div>
                    <div><label class="text-xs">數量/單位</label><div class="flex gap-1"><input type="number" id="i_qty"><input type="text" id="i_unit" placeholder="g" class="w-16"></div></div>
                    <div><label class="text-xs">進貨總額</label><input type="number" id="i_total"></div>
                </div>
                <button onclick="saveInventory()" class="btn-primary mt-4 w-full" style="background:#4B5563">確認進貨</button>
            </div>
            <div id="list_inventory" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </section>

        <section id="tab-items" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">品項配方設定</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="card">
                        <label class="text-xs">品項名稱</label><input type="text" id="p_name">
                        <label class="text-xs mt-3 block">售價</label><input type="number" id="p_price" oninput="calcLive()">
                        <div class="mt-4 p-4 bg-gray-50 rounded-lg border">
                            <p class="text-[10px] font-bold text-gray-400 mb-2">材料配方 (勾選並填入用量)</p>
                            <div id="recipe_check_list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                        </div>
                        <div id="live_calc" class="mt-4 p-3 rounded-lg bg-[#8E9775] text-white text-center hidden">
                            <div class="text-xs opacity-80">估計成本: <span id="live_cost">0</span> | 利潤: <span id="live_profit">0</span></div>
                        </div>
                        <button onclick="saveProduct()" class="btn-primary w-full mt-4">儲存品項</button>
                    </div>
                </div>
                <div class="lg:col-span-2"><div id="list_products" class="space-y-3"></div></div>
            </div>
        </section>

        <section id="tab-stats" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">銷售分析報表</h2>
                <div class="flex bg-white rounded-lg p-1 shadow-sm">
                    <button onclick="setStatsView('day')" id="view-day" class="px-4 py-1 rounded-md text-sm font-bold">日</button>
                    <button onclick="setStatsView('month')" id="view-month" class="px-4 py-1 rounded-md text-sm font-bold">月</button>
                    <button onclick="setStatsView('year')" id="view-year" class="px-4 py-1 rounded-md text-sm font-bold">年</button>
                </div>
            </div>
            <div id="stats_summary" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6"></div>
            <div class="card"><canvas id="statsChart" class="w-full h-64"></canvas></div>
            <div class="card overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-gray-50"><tr class="text-xs font-bold text-gray-500 uppercase border-b">
                        <th class="p-4">時間段</th><th class="p-4">銷售額</th><th class="p-4">利潤</th><th class="p-4">訂單數</th>
                    </tr></thead>
                    <tbody id="stats_table_body"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // Firebase 配置
        const firebaseConfig = {
            apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk",
            databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let materials = {}, products = {}, orders = {}, statsView = 'month';

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        }

        // --- 進貨與庫存 ---
        function saveInventory() {
            const name = document.getElementById('i_name').value;
            const date = document.getElementById('i_date').value || new Date().toISOString().split('T')[0];
            const qty = parseFloat(document.getElementById('i_qty').value);
            const total = parseFloat(document.getElementById('i_total').value);
            const unit = document.getElementById('i_unit').value || 'g';
            if(!name || !qty) return alert("請填寫完整進貨資訊");
            db.ref('inventory').push({ name, date, qty, total, unit, unitPrice: total/qty, currentStock: qty });
            alert("進貨成功！");
        }

        // --- 品項配方與即時計算 ---
        function calcLive() {
            let cost = 0;
            const price = parseFloat(document.getElementById('p_price').value || 0);
            const checks = document.querySelectorAll('.m-check');
            checks.forEach(cb => {
                if(cb.checked) {
                    const mid = cb.value;
                    const qty = parseFloat(document.getElementById('q-' + mid).value || 0);
                    if(materials[mid]) cost += (materials[mid].unitPrice * qty);
                }
            });
            document.getElementById('live_calc').classList.remove('hidden');
            document.getElementById('live_cost').innerText = Math.round(cost);
            document.getElementById('live_profit').innerText = Math.round(price - cost);
        }

        function saveProduct() {
            const name = document.getElementById('p_name').value;
            const price = parseFloat(document.getElementById('p_price').value || 0);
            let recipe = {}, cost = 0;
            const checks = document.querySelectorAll('.m-check');
            checks.forEach(cb => {
                if(cb.checked) {
                    const mid = cb.value;
                    const qty = parseFloat(document.getElementById('q-' + mid).value || 0);
                    recipe[mid] = qty;
                    cost += (materials[mid].unitPrice * qty);
                }
            });
            db.ref('products').push({ name, price, recipe, cost, profit: price - cost });
            alert("產品儲存成功");
        }

        // --- 訂單管理 ---
        function saveOrder() {
            const pid = document.getElementById('o_item_sel').value;
            const cust = document.getElementById('o_cust').value;
            const date = document.getElementById('o_date').value;
            const price = parseFloat(document.getElementById('o_price').value);
            const source = document.getElementById('o_source').value;
            if(!pid || !cust || !date) return alert("請填寫訂單內容");
            const p = products[pid];
            db.ref('orders').push({ 
                cust, date, source, pid, itemName: p.name, price, 
                cost: p.cost, profit: price - p.cost, status: '製作中', 
                timestamp: Date.now() 
            });
            // 扣除庫存邏輯 (簡化處理)
            if(p.recipe) {
                Object.keys(p.recipe).forEach(mid => {
                    const used = p.recipe[mid];
                    db.ref(`inventory/${mid}/currentStock`).transaction(s => (s || 0) - used);
                });
            }
        }

        function updateStatus(id, newStatus) { db.ref(`orders/${id}/status`).set(newStatus); }

        // --- 資料渲染 ---
        db.ref('inventory').on('value', snap => {
            materials = snap.val() || {};
            const list = document.getElementById('list_inventory');
            const checkList = document.getElementById('recipe_check_list');
            list.innerHTML = ""; checkList.innerHTML = "";
            Object.keys(materials).forEach(id => {
                const m = materials[id];
                list.innerHTML += `<div class="card !p-4 border-l-4 border-gray-400">
                    <div class="flex justify-between"><b>${m.name}</b><small>${m.date}</small></div>
                    <div class="flex justify-between mt-2 text-sm"><span>庫存: ${Math.round(m.currentStock)}${m.unit}</span><button onclick="del('inventory','${id}')" class="text-red-400">刪除</button></div>
                </div>`;
                checkList.innerHTML += `<div class="flex items-center gap-2 p-1 border-b text-xs">
                    <input type="checkbox" class="m-check w-4 h-4" value="${id}" onchange="calcLive()">
                    <span class="flex-1">${m.name}</span>
                    <input type="number" id="q-${id}" class="w-16 p-1 border rounded" placeholder="用量" oninput="calcLive()">
                </div>`;
            });
        });

        db.ref('products').on('value', snap => {
            products = snap.val() || {};
            const list = document.getElementById('list_products');
            const sel = document.getElementById('o_item_sel');
            list.innerHTML = ""; sel.innerHTML = '<option value="">選擇產品</option>';
            Object.keys(products).forEach(id => {
                const p = products[id];
                sel.innerHTML += `<option value="${id}">${p.name}</option>`;
                list.innerHTML += `<div class="card !p-4 flex justify-between items-center">
                    <div><b>${p.name}</b><br><small class="text-gray-400">售價: $${p.price} | 成本: $${Math.round(p.cost)} | 利潤: $${Math.round(p.profit)}</small></div>
                    <button onclick="del('products','${id}')" class="text-gray-300">×</button>
                </div>`;
            });
        });

        db.ref('orders').on('value', snap => {
            orders = snap.val() || {};
            const list = document.getElementById('list_orders');
            list.innerHTML = "";
            let totalSales = 0, totalProfit = 0;
            
            Object.keys(orders).sort((a,b) => orders[b].date.localeCompare(orders[a].date)).forEach(id => {
                const o = orders[id];
                totalSales += o.price; totalProfit += o.profit;
                
                // 倒數警示
                const today = new Date().toISOString().split('T')[0];
                const diff = (new Date(o.date) - new Date(today)) / (1000*60*60*24);
                let alertClass = diff < 0 ? "urgent" : (diff <= 1 ? "urgent" : "text-gray-500");
                let diffText = diff === 0 ? "今天交貨！" : (diff < 0 ? `逾期 ${Math.abs(diff)} 天` : `${diff} 天後交貨`);

                list.innerHTML += `<div class="card !p-0 overflow-hidden border-l-4 ${o.status==='已完成'?'border-green-400':'border-[#8E9775]'}">
                    <div class="p-4 flex justify-between items-center cursor-pointer" onclick="document.getElementById('detail-${id}').classList.toggle('hidden')">
                        <div><span class="text-xs font-bold text-gray-400">[${o.source}]</span> <b>${o.cust}</b> <small class="ml-2 ${alertClass}">${diffText}</small></div>
                        <div class="flex items-center gap-3">
                            <select onchange="updateStatus('${id}', this.value)" class="text-xs p-1 !w-24 mt-0">
                                <option ${o.status==='製作中'?'selected':''}>製作中</option>
                                <option ${o.status==='已完成'?'selected':''}>已完成</option>
                            </select>
                            <button onclick="del('orders','${id}')" class="text-red-300">×</button>
                        </div>
                    </div>
                    <div id="detail-${id}" class="hidden p-4 bg-gray-50 border-t text-sm">
                        品項: ${o.itemName} | 實收: $${o.price} | 交貨日: ${o.date}
                    </div>
                </div>`;
            });
            renderStats();
        });

        // --- 報表邏輯 ---
        function setStatsView(v) { statsView = v; renderStats(); }

        function renderStats() {
            const table = document.getElementById('stats_table_body');
            const summary = document.getElementById('stats_summary');
            table.innerHTML = "";
            let dataMap = {}, grandSales = 0, grandProfit = 0;

            Object.values(orders).forEach(o => {
                let key = o.date; // default day
                if(statsView === 'month') key = o.date.substring(0, 7);
                if(statsView === 'year') key = o.date.substring(0, 4);

                if(!dataMap[key]) dataMap[key] = { sales: 0, profit: 0, count: 0 };
                dataMap[key].sales += o.price;
                dataMap[key].profit += o.profit;
                dataMap[key].count++;
                grandSales += o.price;
                grandProfit += o.profit;
            });

            summary.innerHTML = `
                <div class="card text-center bg-[#8E9775] text-white"><h6>總銷售額</h6><b class="text-2xl">$${grandSales}</b></div>
                <div class="card text-center"><h6>總利潤</h6><b class="text-2xl text-[#8E9775]">$${Math.round(grandProfit)}</b></div>
                <div class="card text-center"><h6>平均客單價</h6><b class="text-2xl">$${Math.round(grandSales / (Object.keys(orders).length || 1))}</b></div>
            `;

            Object.keys(dataMap).sort().reverse().forEach(key => {
                const d = dataMap[key];
                table.innerHTML += `<tr class="border-b hover:bg-gray-50">
                    <td class="p-4 font-bold">${key}</td>
                    <td class="p-4">$${d.sales}</td>
                    <td class="p-4 text-green-600">$${Math.round(d.profit)}</td>
                    <td class="p-4">${d.count} 筆</td>
                </tr>`;
            });

            // 處理按鈕顏色
            ['day','month','year'].forEach(v => {
                const btn = document.getElementById('view-' + v);
                btn.className = (statsView === v) ? "px-4 py-1 rounded-md text-sm font-bold bg-[#8E9775] text-white" : "px-4 py-1 rounded-md text-sm font-bold text-gray-400";
            });
        }

        function autoFillPrice() { 
            const id = document.getElementById('o_item_sel').value; 
            if(id && products[id]) document.getElementById('o_price').value = products[id].price; 
        }
        function del(path, id) { if(confirm("確定刪除此資料？")) db.ref(path + '/' + id).remove(); }
    </script>
</body>
</html>
