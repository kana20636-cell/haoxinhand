<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>好心手作管理系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    
    <style>
        body { background-color: #F8F9FA; color: #374151; font-family: "PingFang TC", sans-serif; }
        .sidebar { width: 240px; height: 100vh; position: sticky; top: 0; background: white; border-right: 1px solid #E5E7EB; }
        .nav-btn { width: 100%; text-align: left; padding: 1rem 1.5rem; font-weight: 600; color: #6B7280; transition: 0.2s; }
        .nav-btn.active { background-color: #F3F4F6; color: #8E9775; border-right: 4px solid #8E9775; }
        .card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1.5rem; }
        
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .full-row { grid-column: span 2; }
        
        input, select { border: 1px solid #D1D5DB; padding: 0.6rem; border-radius: 8px; width: 100%; font-size: 16px; }
        .btn-primary { background: #8E9775; color: white; padding: 0.8rem; border-radius: 8px; font-weight: 700; width: 100%; margin-top: 1rem; }
        
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .status-making { background: #FEF3C7; color: #D97706; }
        .status-shipped { background: #DBEAFE; color: #2563EB; }
        .status-done { background: #D1FAE5; color: #059669; }
        
        /* 工作天警示 */
        .order-urgent { border-left: 10px solid #EF4444 !important; }   /* 紅色: 5天內 */
        .order-warning { border-left: 10px solid #F59E0B !important; }  /* 橘色: 10天內 */
        .order-safe { border-left: 10px solid #10B981 !important; }     /* 綠色: 充足 */
        .order-completed { border-left: 10px solid #E5E7EB !important; }/* 灰色: 已完成 */
    </style>
</head>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk",
        authDomain: "haoxin-44098.firebaseapp.com",
        databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "haoxin-44098",
        storageBucket: "haoxin-44098.firebasestorage.app",
        messagingSenderId: "878734507134",
        appId: "1:878734507134:web:91598cf6816d401e66ac2f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 計算剩餘工作天 (不含週末)
    function getWorkingDaysLeft(targetDateStr) {
        const today = new Date();
        today.setHours(0,0,0,0);
        const target = new Date(targetDateStr);
        target.setHours(0,0,0,0);
        
        if (target < today) return -1; // 已逾期

        let count = 0;
        let cur = new Date(today);
        while (cur < target) {
            cur.setDate(cur.getDate() + 1);
            const day = cur.getDay();
            if (day !== 0 && day !== 6) { // 0是週日, 6是週六
                count++;
            }
        }
        return count;
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(event) event.currentTarget.classList.add('active');
    }

    // --- 訂單管理 ---
    function addNewOrder() {
        const d = {
            date: document.getElementById('orderDate').value,
            cust: document.getElementById('custName').value,
            item: document.getElementById('orderItemSelect').value,
            price: parseFloat(document.getElementById('orderPrice').value || 0),
            source: document.getElementById('orderSource').value,
            status: '製作中'
        };
        if(d.cust && d.date && d.item) {
            db.ref('orders').push(d).then(() => {
                alert('訂單已建立');
                document.getElementById('custName').value = '';
            });
        } else {
            alert('請填寫完整資訊（包含日期）');
        }
    }

    function updateStatus(id, newStatus) {
        db.ref('orders/' + id).update({ status: newStatus });
    }

    db.ref('orders').on('value', snap => {
        const list = document.getElementById('orderListDisplay');
        list.innerHTML = "";
        const data = snap.val();
        if(!data) return;

        Object.keys(data).sort((a,b) => data[a].date.localeCompare(data[b].date)).forEach(id => {
            const o = data[id];
            const wdLeft = getWorkingDaysLeft(o.date);
            
            // 決定警示樣式
            let alertClass = 'order-safe';
            let dayText = `剩餘 ${wdLeft} 工作天`;

            if (o.status === '已完成') {
                alertClass = 'order-completed';
                dayText = '訂單已結案';
            } else {
                if (wdLeft < 0) {
                    alertClass = 'order-urgent';
                    dayText = '已逾期！';
                } else if (wdLeft <= 5) {
                    alertClass = 'order-urgent'; // 紅色
                } else if (wdLeft <= 10) {
                    alertClass = 'order-warning'; // 橘色
                }
            }

            let statusClass = 'status-making';
            if (o.status === '已出貨') statusClass = 'status-shipped';
            if (o.status === '已完成') statusClass = 'status-done';

            list.innerHTML += `
                <div class="card ${alertClass} flex justify-between items-center">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="status-tag ${statusClass}">${o.status}</span>
                            <span class="text-xs font-bold text-gray-500">${dayText}</span>
                        </div>
                        <b class="text-lg">${o.cust}</b> <span class="text-xs text-gray-400">[${o.source}]</span>
                        <p class="text-sm text-gray-600">${o.item}</p>
                        <small class="text-gray-400 text-xs">交貨日期：${o.date}</small>
                    </div>
                    <div class="text-right">
                        <b class="text-xl">$${o.price}</b><br>
                        <select onchange="updateStatus('${id}', this.value)" class="text-xs border mt-2 p-1 rounded">
                            <option value="製作中" ${o.status=='製作中'?'selected':''}>製作中</option>
                            <option value="已出貨" ${o.status=='已出貨'?'selected':''}>已出貨</option>
                            <option value="已完成" ${o.status=='已完成'?'selected':''}>已完成</option>
                        </select>
                        <button onclick="del('orders','${id}')" class="text-red-300 text-xs ml-2">刪除</button>
                    </div>
                </div>`;
        });
    });

    // --- 品項與進貨 (維持功能) ---
    function addItem() {
        const n = document.getElementById('itemName').value;
        const c = parseFloat(document.getElementById('itemCost').value || 0);
        const p = parseFloat(document.getElementById('itemPrice').value || 0);
        const q = document.getElementById('itemQty').value;
        const u = document.getElementById('itemUnit').value;
        if(n) db.ref('items').push({ name: n, cost: c, price: p, qty: q, unit: u });
    }

    db.ref('items').on('value', snap => {
        const list = document.getElementById('itemsListDisplay');
        const oSel = document.getElementById('orderItemSelect');
        list.innerHTML = ""; oSel.innerHTML = '<option value="">選擇產品</option>';
        if(!snap.val()) return;
        Object.keys(snap.val()).forEach(id => {
            const i = snap.val()[id];
            const spec = `${i.qty||''}${i.unit||''}`;
            list.innerHTML += `<div class="p-2 border-b text-sm flex justify-between">
                <span>${i.name} (${spec}) - 成本$${i.cost} / 售價$${i.price}</span>
                <button onclick="del('items','${id}')" class="text-red-300">×</button></div>`;
            oSel.innerHTML += `<option value="${i.name} (${spec})">${i.name} (${spec})</option>`;
        });
    });

    function addInventory() {
        const d = { date: document.getElementById('invDate').value, name: document.getElementById('invName').value, qty: document.getElementById('invQty').value, unit: document.getElementById('invUnit').value, price: parseFloat(document.getElementById('invPrice').value || 0) };
        if(d.name) db.ref('inventory').push(d);
    }
    db.ref('inventory').on('value', snap => {
        const list = document.getElementById('inventoryListDisplay'); list.innerHTML = "";
        if(!snap.val()) return;
        Object.keys(snap.val()).forEach(id => {
            const v = snap.val()[id];
            list.innerHTML += `<div class="bg-white p-2 border rounded text-xs mb-1 flex justify-between"><span>${v.date} ${v.name}</span><b>$${v.price}</b></div>`;
        });
    });

    function del(p, id) { if(confirm("確定刪除？")) db.ref(p+'/'+id).remove(); }
</script>
<body class="flex">
    <aside class="sidebar">
        <div class="py-8">
            <h1 class="text-xl font-bold mb-10 text-center text-[#8E9775]">好心手作</h1>
            <nav>
                <button onclick="showTab('orders')" class="nav-btn active">訂單追蹤</button>
                <button onclick="showTab('inventory')" class="nav-btn">進貨紀錄</button>
                <button onclick="showTab('items')" class="nav-btn">品項成本</button>
            </nav>
        </div>
    </aside>

    <main class="flex-1 p-6 max-w-5xl">
        <section id="orders" class="tab-content">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">訂單追蹤</h2>
            <div class="card">
                <div class="form-grid">
                    <div class="full-row"><input type="text" id="custName" placeholder="顧客姓名"></div>
                    <input type="date" id="orderDate">
                    <select id="orderSource">
                        <option value="LINE">LINE</option>
                        <option value="FB/IG">FB/IG</option>
                        <option value="社群">社群</option>
                    </select>
                    <div class="full-row"><select id="orderItemSelect"></select></div>
                    <div class="full-row"><input type="number" id="orderPrice" placeholder="銷售金額"></div>
                </div>
                <button onclick="addNewOrder()" class="btn-primary">建立新訂單</button>
            </div>
            <div id="orderListDisplay" class="space-y-4"></div>
        </section>

        <section id="inventory" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">進貨紀錄</h2>
            <div class="card">
                <div class="form-grid">
                    <div class="full-row"><input type="text" id="invName" placeholder="材料名稱"></div>
                    <input type="date" id="invDate">
                    <div class="flex gap-2"><input type="number" id="invQty" placeholder="數"><input type="text" id="invUnit" placeholder="位"></div>
                    <div class="full-row"><input type="number" id="invPrice" placeholder="總金額"></div>
                </div>
                <button onclick="addInventory()" class="btn-primary" style="background:#4B5563">儲存進貨</button>
            </div>
            <div id="inventoryListDisplay" class="space-y-1"></div>
        </section>

        <section id="items" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-6">品項管理</h2>
            <div class="card">
                <div class="form-grid">
                    <div class="full-row"><input type="text" id="itemName" placeholder="產品名稱"></div>
                    <input type="number" id="itemQty" placeholder="數量 (如:10)">
                    <input type="text" id="itemUnit" placeholder="單位 (如:入)">
                    <input type="number" id="itemCost" placeholder="成本">
                    <input type="number" id="itemPrice" placeholder="售價">
                </div>
                <button onclick="addItem()" class="btn-primary">存入清單</button>
                <div id="itemsListDisplay" class="mt-6"></div>
            </div>
        </section>
    </main>
</body>
</html>
