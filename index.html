<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>好心手作 - 營運管理系統 (自動日期優化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background-color: #F3F4F6; display: flex; font-family: sans-serif; min-height: 100vh; }
        .sidebar { width: 220px; background: white; border-right: 1px solid #E5E7EB; position: fixed; height: 100%; z-index: 50; }
        .nav-btn { width: 100%; text-align: left; padding: 1rem 1.5rem; font-weight: 600; color: #4B5563; }
        .nav-btn.active { background: #F9FAFB; color: #8E9775; border-right: 4px solid #8E9775; }
        main { margin-left: 220px; padding: 25px; width: calc(100% - 220px); }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden { display: none !important; }
        input, select { border: 1px solid #D1D5DB; padding: 8px; border-radius: 8px; width: 100%; margin-top: 4px; outline:none; }
        .btn-primary { background: #8E9775; color: white; padding: 10px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; border:none; }
        .count-red { color: #EF4444; font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-8 text-xl font-black text-[#8E9775]">好心手作</div>
        <nav>
            <button onclick="showTab('orders')" id="btn-orders" class="nav-btn active">訂單追蹤</button>
            <button onclick="showTab('inventory')" id="btn-inventory" class="nav-btn">材料進貨</button>
            <button onclick="showTab('items')" id="btn-items" class="nav-btn">品項配方</button>
            <button onclick="showTab('customers')" id="btn-customers" class="nav-btn">顧客資料</button>
            <button onclick="showTab('stats')" id="btn-stats" class="nav-btn">銷售報表</button>
        </nav>
    </aside>

    <main>
        <section id="tab-orders" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">訂單追蹤</h2>
            <div class="card">
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div><label class="text-xs">顧客姓名</label><input type="text" id="o_cust"></div>
                    <div><label class="text-xs">下單日期</label><input type="date" id="o_create_date"></div>
                    <div><label class="text-xs">交貨日期 (自動預估21工作日)</label><input type="date" id="o_delivery_date"></div>
                    <div><label class="text-xs">來源</label><select id="o_source"><option>LINE</option><option>IG/FB</option><option>現場</option></select></div>
                    <div><label class="text-xs">產品</label><select id="o_item_sel" onchange="autoFillPrice()"></select></div>
                    <div class="col-span-2 md:col-span-4"><label class="text-xs">實收金額</label><input type="number" id="o_price"></div>
                    <div class="col-span-2 md:col-span-1 flex items-end"><button onclick="saveOrder()" class="btn-primary">建立訂單</button></div>
                </div>
            </div>
            <div id="list_orders" class="space-y-3"></div>
        </section>

        <section id="tab-inventory" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">材料庫存管理</h2>
            <div class="card">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                    <div class="col-span-2"><label class="text-xs">材料名稱</label><input type="text" id="i_name" list="mat_options"><datalist id="mat_options"></datalist></div>
                    <div><label class="text-xs">進貨日期</label><input type="date" id="i_date"></div>
                    <div><label class="text-xs">數量 / 單位</label><div class="flex gap-1"><input type="number" id="i_qty"><input type="text" id="i_unit" placeholder="g" class="w-12"></div></div>
                    <div><label class="text-xs">總金額</label><input type="number" id="i_total"></div>
                </div>
                <button onclick="saveInventory()" class="btn-primary mt-4 bg-[#4B5563]">新增進貨紀錄</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="card"><h3 class="font-bold mb-3 text-[#8E9775]">目前總庫存</h3><div id="stock_summary" class="grid grid-cols-2 gap-2 text-sm"></div></div>
                <div class="card"><h3 class="font-bold mb-3 text-[#8E9775]">進貨歷史紀錄</h3><div id="list_inventory" class="space-y-2 max-h-96 overflow-y-auto"></div></div>
            </div>
        </section>

        <section id="tab-items" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4">品項配方設定</h2><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="card h-fit"><label class="text-xs">品項名稱</label><input type="text" id="p_name"><label class="text-xs mt-3 block">售價</label><input type="number" id="p_price" oninput="calcLive()"><div id="recipe_check_list" class="mt-4 p-3 bg-gray-50 rounded-lg border space-y-2"></div><div id="live_calc" class="mt-4 p-3 bg-[#8E9775] text-white text-center text-xs">成本: <span id="live_cost">0</span> | 利潤: <span id="live_profit">0</span></div><button onclick="saveProduct()" class="btn-primary mt-4">儲存品項</button></div><div class="lg:col-span-2" id="list_products"></div></div></section>
        <section id="tab-customers" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4">顧客資料</h2><div id="list_customers" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div></section>
        <section id="tab-stats" class="tab-content hidden"><h2 class="text-2xl font-bold mb-4">銷售分析</h2><div id="stats_summary" class="grid grid-cols-3 gap-4 mb-6"></div><div class="card"><table class="w-full text-sm text-left"><thead class="bg-gray-50"><tr><th class="p-3">品項</th><th>銷量</th><th>營收</th><th>利潤</th><th>利潤率</th></tr></thead><tbody id="product_stats_body"></tbody></table></div></section>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk",
            databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let materials = {}, products = {}, orders = {}, stocks = {};

        // --- 初始化頁面日期 ---
        window.onload = function() {
            resetOrderDates();
            document.getElementById('i_date').value = new Date().toISOString().split('T')[0];
        };

        // --- 核心邏輯：計算指定工作日後的日期 ---
        function calculateFutureWorkingDay(startDate, daysToAdd) {
            let date = new Date(startDate);
            let addedDays = 0;
            while (addedDays < daysToAdd) {
                date.setDate(date.getDate() + 1);
                if (date.getDay() !== 0 && date.getDay() !== 6) { // 0=日, 6=六
                    addedDays++;
                }
            }
            return date.toISOString().split('T')[0];
        }

        // --- 重設日期欄位 ---
        function resetOrderDates() {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            document.getElementById('o_create_date').value = todayStr;
            // 自動計算 21 個工作天後的日期
            document.getElementById('o_delivery_date').value = calculateFutureWorkingDay(today, 21);
        }

        // --- 工作日倒數警示計算 ---
        function getWorkingDaysLeft(deliveryDate) {
            let today = new Date(); today.setHours(0,0,0,0);
            let target = new Date(deliveryDate);
            if (target < today) return -1;
            let count = 0; let temp = new Date(today);
            while (temp <= target) { if(temp.getDay() !== 0 && temp.getDay() !== 6) count++; temp.setDate(temp.getDate() + 1); }
            return count;
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        }

        // --- 1. 進貨邏輯 ---
        function saveInventory() {
            const name = document.getElementById('i_name').value.trim();
            const date = document.getElementById('i_date').value;
            const qty = parseFloat(document.getElementById('i_qty').value);
            const total = parseFloat(document.getElementById('i_total').value);
            const unit = document.getElementById('i_unit').value || 'g';
            if(!name || !qty) return alert("請填寫品項與數量");
            const unitPrice = total / qty;
            db.ref('inventory_logs').push({ name, date, qty, total, unit, unitPrice, timestamp: Date.now() });
            db.ref('stocks').child(name).transaction(s => {
                if(!s) return { name, currentQty: qty, unit, avgUnitPrice: unitPrice };
                const newQty = s.currentQty + qty;
                const newAvgPrice = ((s.avgUnitPrice * s.currentQty) + total) / newQty;
                return { ...s, currentQty: newQty, avgUnitPrice: newAvgPrice };
            });
            alert("進貨紀錄已儲存");
            document.getElementById('i_name').value = ""; document.getElementById('i_qty').value = ""; document.getElementById('i_total').value = "";
        }

        // --- 2. 訂單邏輯 (含自動重設日期) ---
        function saveOrder() {
            const pid = document.getElementById('o_item_sel').value;
            const cust = document.getElementById('o_cust').value.trim();
            const deliveryDate = document.getElementById('o_delivery_date').value;
            const price = parseFloat(document.getElementById('o_price').value);
            if(!pid || !cust || !deliveryDate) return alert("資訊不全");
            const p = products[pid];
            db.ref('orders').push({
                cust, createDate: document.getElementById('o_create_date').value,
                deliveryDate, source: document.getElementById('o_source').value,
                pid, itemName: p.name, price, cost: p.cost, profit: price - p.cost, status: '製作中'
            }).then(() => {
                if(p.recipe) {
                    Object.keys(p.recipe).forEach(mName => {
                        db.ref(`stocks/${mName}/currentQty`).transaction(q => (q || 0) - p.recipe[mName]);
                    });
                }
                alert("訂單已建立");
                document.getElementById('o_cust').value = "";
                resetOrderDates(); // 建立後自動重新整理日期
            });
        }

        // --- 以下為數據監聽與渲染邏輯 (保留原功能) ---
        db.ref('stocks').on('value', snap => {
            stocks = snap.val() || {};
            const summary = document.getElementById('stock_summary');
            const checkList = document.getElementById('recipe_check_list');
            const datalist = document.getElementById('mat_options');
            summary.innerHTML = ""; checkList.innerHTML = ""; datalist.innerHTML = "";
            Object.keys(stocks).forEach(name => {
                const s = stocks[name];
                summary.innerHTML += `<div class="p-2 border rounded"><b>${name}</b><br><span class="${s.currentQty < 100 ? 'text-red-500 font-bold':''}">${Math.round(s.currentQty)}${s.unit}</span></div>`;
                checkList.innerHTML += `<div class="flex items-center gap-2 text-xs border-b p-1"><input type="checkbox" class="m-check" value="${name}" onchange="calcLive()"><span class="flex-1">${name}</span><input type="number" id="q-${name}" class="w-14 border rounded" oninput="calcLive()"></div>`;
                datalist.innerHTML += `<option value="${name}">`;
            });
        });

        db.ref('inventory_logs').on('value', snap => {
            const list = document.getElementById('list_inventory'); list.innerHTML = "";
            const logs = snap.val() || {};
            Object.keys(logs).sort((a,b) => logs[b].timestamp - logs[a].timestamp).forEach(id => {
                const l = logs[id];
                list.innerHTML += `<div class="text-xs p-2 bg-gray-50 rounded flex justify-between"><span>${l.date} <b>${l.name}</b> +${l.qty}${l.unit}</span><span>$${l.total}</span></div>`;
            });
        });

        db.ref('products').on('value', snap => {
            products = snap.val() || {};
            const list = document.getElementById('list_products');
            const sel = document.getElementById('o_item_sel');
            list.innerHTML = ""; sel.innerHTML = '<option value="">選擇產品</option>';
            Object.keys(products).forEach(id => {
                const p = products[id]; sel.innerHTML += `<option value="${id}">${p.name}</option>`;
                list.innerHTML += `<div class="card !p-4 flex justify-between"><div><b>${p.name}</b><br><small>$${p.price}</small></div><button onclick="del('products','${id}')">×</button></div>`;
            });
        });

        db.ref('orders').on('value', snap => {
            orders = snap.val() || {};
            const list = document.getElementById('list_orders'); list.innerHTML = "";
            Object.keys(orders).sort((a,b) => orders[b].deliveryDate.localeCompare(orders[a].deliveryDate)).forEach(id => {
                const o = orders[id];
                const wDays = getWorkingDaysLeft(o.deliveryDate);
                const color = wDays < 0 ? 'count-red' : (wDays <= 5 ? 'count-red' : (wDays <= 10 ? 'text-orange-500 font-bold' : 'text-green-600'));
                list.innerHTML += `<div class="card !p-3 border-l-4 border-[#8E9775]"><div class="flex justify-between items-center" onclick="document.getElementById('det-${id}').classList.toggle('hidden')"><div><small>[${o.source}]</small> <b>${o.cust}</b> <span class="ml-2 text-xs ${color}">${wDays}工作天 (${o.deliveryDate})</span></div><select onchange="db.ref('orders/${id}/status').set(this.value)" class="text-xs !w-20 p-1"><option ${o.status==='製作中'?'selected':''}>製作中</option><option ${o.status==='已出貨'?'selected':''}>已出貨</option><option ${o.status==='已完成'?'selected':''}>已完成</option></select></div><div id="det-${id}" class="hidden mt-2 pt-2 border-t text-xs text-gray-500">品項: ${o.itemName} | 金額: $${o.price}</div></div>`;
            });
            renderStats();
        });

        function saveProduct() {
            const name = document.getElementById('p_name').value;
            const price = parseFloat(document.getElementById('p_price').value || 0);
            let recipe = {}, cost = 0;
            document.querySelectorAll('.m-check:checked').forEach(cb => {
                const mName = cb.value; const qty = parseFloat(document.getElementById('q-' + mName).value || 0);
                recipe[mName] = qty; cost += (stocks[mName].avgUnitPrice * qty);
            });
            db.ref('products').push({ name, price, recipe, cost, profit: price - cost });
            alert("產品儲存成功");
        }

        function calcLive() {
            let cost = 0; const price = parseFloat(document.getElementById('p_price').value || 0);
            document.querySelectorAll('.m-check:checked').forEach(cb => {
                const qty = parseFloat(document.getElementById('q-' + cb.value).value || 0);
                if(stocks[cb.value]) cost += (stocks[cb.value].avgUnitPrice * qty);
            });
            document.getElementById('live_cost').innerText = Math.round(cost);
            document.getElementById('live_profit').innerText = Math.round(price - cost);
        }

        function renderStats() {
            const pBody = document.getElementById('product_stats_body'); pBody.innerHTML = "";
            let pMap = {}; let tSales = 0, tProfit = 0;
            Object.values(orders).forEach(o => {
                tSales += o.price; tProfit += o.profit;
                if(!pMap[o.itemName]) pMap[o.itemName] = { qty:0, sales:0, profit:0 };
                pMap[o.itemName].qty++; pMap[o.itemName].sales += o.price; pMap[o.itemName].profit += o.profit;
            });
            Object.keys(pMap).forEach(n => {
                const p = pMap[n];
                pBody.innerHTML += `<tr><td class="p-3"><b>${n}</b></td><td>${p.qty}</td><td>$${p.sales}</td><td>$${Math.round(p.profit)}</td><td>${((p.profit/p.sales)*100).toFixed(0)}%</td></tr>`;
            });
            document.getElementById('stats_summary').innerHTML = `<div class="card text-center">營收<br><b>$${tSales}</b></div><div class="card text-center">利潤<br><b>$${Math.round(tProfit)}</b></div><div class="card text-center">訂單<br><b>${Object.keys(orders).length}</b></div>`;
        }

        function del(path, id) { if(confirm("確定刪除？")) db.ref(path + '/' + id).remove(); }
    </script>
</body>
</html>
