<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>好心手作 - 營運管理系統 (成本優化版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background-color: #F3F4F6; display: flex; font-family: sans-serif; min-height: 100vh; }
        .sidebar { width: 220px; background: white; border-right: 1px solid #E5E7EB; position: fixed; height: 100%; }
        .nav-btn { width: 100%; text-align: left; padding: 1rem 1.5rem; font-weight: 600; color: #4B5563; }
        .nav-btn.active { background: #F9FAFB; color: #8E9775; border-right: 4px solid #8E9775; }
        main { margin-left: 220px; padding: 30px; width: calc(100% - 220px); }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none !important; }
        input, select { border: 1px solid #D1D5DB; padding: 10px; border-radius: 8px; width: 100%; margin-top: 5px; }
        label { font-size: 12px; font-weight: bold; color: #6B7280; }
        .btn-primary { background: #8E9775; color: white; padding: 12px; border-radius: 8px; width: 100%; font-weight: bold; cursor: pointer; border: none; margin-top: 10px; }
        .btn-primary:hover { opacity: 0.9; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="p-8 text-xl font-black text-[#8E9775]">好心手作</div>
        <nav>
            <button onclick="showTab('orders')" id="btn-orders" class="nav-btn active">訂單追蹤</button>
            <button onclick="showTab('inventory')" id="btn-inventory" class="nav-btn">材料進貨</button>
            <button onclick="showTab('items')" id="btn-items" class="nav-btn">品項配方</button>
            <button onclick="showTab('customers')" id="btn-customers" class="nav-btn">顧客維護</button>
            <button onclick="showTab('stats')" id="btn-stats" class="nav-btn">銷售報表</button>
        </nav>
    </aside>

    <main>
        <section id="tab-orders" class="tab-content">
            <h2 class="text-2xl font-bold mb-4">訂單管理</h2>
            <div class="card">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label>顧客姓名</label><input type="text" id="order_cust"></div>
                    <div><label>交貨日期</label><input type="date" id="order_date"></div>
                    <div><label>來源</label><select id="order_source"><option>LINE</option><option>FB/IG</option><option>現場</option></select></div>
                    <div class="col-span-2"><label>選擇產品</label><select id="order_item_sel" onchange="autoFillPrice()"></select></div>
                    <div class="col-span-2"><label>實收金額</label><input type="number" id="order_actual_price"></div>
                </div>
                <button onclick="addOrder()" class="btn-primary">建立新訂單</button>
            </div>
            <div id="list_orders" class="space-y-3"></div>
        </section>

        <section id="tab-inventory" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">材料進貨</h2>
            <div class="card border-l-8 border-gray-400">
                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2"><label>材料名稱</label><input type="text" id="inv_name"></div>
                    <div><label>進貨數量</label><input type="number" id="inv_qty"></div>
                    <div><label>單位</label><input type="text" id="inv_unit" value="g"></div>
                    <div class="col-span-2"><label>進貨總金額</label><input type="number" id="inv_price"></div>
                </div>
                <button onclick="addInventory()" class="btn-primary" style="background:#4B5563">確認入庫</button>
            </div>
            <div id="list_inventory" class="grid grid-cols-2 gap-4"></div>
        </section>

        <section id="tab-items" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">品項與成本配方</h2>
            <div class="card bg-gray-50 border-2 border-dashed">
                <label>第一步：管理分類</label>
                <div class="flex gap-2 mt-2"><input type="text" id="new_cat_name" placeholder="如：巴斯克"><button onclick="addCategory()" class="bg-gray-600 text-white px-4 rounded-lg">新增分類</button></div>
                <div id="list_cats" class="flex flex-wrap gap-2 mt-3"></div>
            </div>
            <div class="card border-l-8 border-[#8E9775]">
                <label>第二步：設定產品與配方</label>
                <div class="grid grid-cols-2 gap-4 mt-2">
                    <div><label>產品分類</label><select id="item_cat_sel"></select></div>
                    <div><label>產品名稱</label><input type="text" id="item_name"></div>
                    <div class="col-span-2"><label>預設售價</label><input type="number" id="item_price"></div>
                </div>
                <div class="mt-4 p-4 bg-gray-100 rounded-lg">
                    <p class="text-xs font-bold text-[#8E9775] mb-2 uppercase">配方材料設定 (請勾選並填入用量)</p>
                    <div id="recipe_builder" class="space-y-2">
                        </div>
                </div>
                <button onclick="addItem()" class="btn-primary">儲存品項並計算利潤</button>
            </div>
            <div id="list_items" class="space-y-3"></div>
        </section>

        <section id="tab-customers" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">顧客維護</h2>
            <div id="list_customers" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </section>

        <section id="tab-stats" class="tab-content hidden">
            <h2 class="text-2xl font-bold mb-4">銷售報表</h2>
            <div id="stats_summary" class="grid grid-cols-3 gap-6 mb-6"></div>
            <div class="card">
                <table class="w-full text-sm text-left">
                    <thead><tr class="text-gray-400 border-b"><th class="pb-2">產品</th><th>銷量</th><th>累積利潤</th></tr></thead>
                    <tbody id="stats_table"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script>
        // --- Firebase 配置 ---
        const firebaseConfig = {
            apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk",
            databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let materials = {};
        let products = {};

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.getElementById('btn-' + id).classList.add('active');
        }

        // --- 1. 訂單功能 ---
        function autoFillPrice() {
            const id = document.getElementById('order_item_sel').value;
            if(id && products[id]) document.getElementById('order_actual_price').value = products[id].price;
        }

        function addOrder() {
            const pid = document.getElementById('order_item_sel').value;
            const cust = document.getElementById('order_cust').value;
            const date = document.getElementById('order_date').value;
            const price = parseFloat(document.getElementById('order_actual_price').value);
            const source = document.getElementById('order_source').value;
            if(!pid || !cust || !date) return alert("請填寫完整訂單資訊");
            const p = products[pid];
            db.ref('orders').push({
                cust, date, source, itemName: p.name, price,
                cost: p.totalCost, profit: price - p.totalCost, status: '製作中'
            }).then(() => { document.getElementById('order_cust').value = ""; alert("訂單已建立"); });
        }

        // --- 2. 材料功能 ---
        function addInventory() {
            const name = document.getElementById('inv_name').value;
            const qty = parseFloat(document.getElementById('inv_qty').value);
            const price = parseFloat(document.getElementById('inv_price').value);
            const unit = document.getElementById('inv_unit').value;
            if(name && qty > 0) {
                db.ref('inventory').push({ name, qty, unit, price, unitPrice: price/qty })
                .then(() => { document.getElementById('inv_name').value = ""; alert("材料已入庫"); });
            }
        }

        // --- 3. 品項與配方功能 (優化核心) ---
        function addCategory() {
            const name = document.getElementById('new_cat_name').value;
            if(name) db.ref('categories').push(name).then(() => document.getElementById('new_cat_name').value = "");
        }

        // 核心：點擊儲存品項時的運算與防呆
        function addItem() {
            const name = document.getElementById('item_name').value;
            const cat = document.getElementById('item_cat_sel').value;
            const price = parseFloat(document.getElementById('item_price').value || 0);
            
            if(!name || !cat) return alert("❌ 請填寫產品名稱並選擇分類");

            let totalCost = 0;
            let hasCheckedMaterial = false;

            // 抓取畫面上所有被勾選的材料框
            const materialCheckboxes = document.querySelectorAll('.m-check:checked');
            
            materialCheckboxes.forEach(el => {
                hasCheckedMaterial = true;
                const mid = el.value; // 材料的 Firebase ID
                const qtyInput = el.parentElement.querySelector('.m-qty');
                const useQty = parseFloat(qtyInput.value || 0);
                
                if (materials[mid]) {
                    totalCost += (materials[mid].unitPrice * useQty);
                }
            });

            if(!hasCheckedMaterial) {
                if(!confirm("⚠️ 您尚未勾選任何配方材料，這將使產品成本為 0。確定要儲存嗎？")) return;
            }

            // 儲存到 Firebase
            db.ref('items').push({
                name: name,
                category: cat,
                price: price,
                totalCost: totalCost,
                profit: price - totalCost
            }).then(() => {
                alert("✅ 品項【" + name + "】儲存成功！");
                // 清空輸入框
                document.getElementById('item_name').value = "";
                document.getElementById('item_price').value = "";
                document.querySelectorAll('.m-check').forEach(c => c.checked = false);
                document.querySelectorAll('.m-qty').forEach(q => q.value = "");
            }).catch(err => alert("❌ 儲存失敗：" + err.message));
        }

        // --- 數據同步 ---
        db.ref('categories').on('value', snap => {
            const div = document.getElementById('list_cats');
            const sel = document.getElementById('item_cat_sel');
            div.innerHTML = ""; sel.innerHTML = '<option value="">請選擇</option>';
            const data = snap.val() || {};
            Object.keys(data).forEach(id => {
                div.innerHTML += `<span class="bg-gray-200 px-3 py-1 rounded-full text-xs">${data[id]} <button onclick="del('categories','${id}')" class="text-red-500">×</button></span>`;
                sel.innerHTML += `<option value="${data[id]}">${data[id]}</option>`;
            });
        });

        db.ref('inventory').on('value', snap => {
            const div = document.getElementById('list_inventory');
            const builder = document.getElementById('recipe_builder');
            div.innerHTML = ""; builder.innerHTML = "";
            materials = snap.val() || {};
            Object.keys(materials).forEach(id => {
                const m = materials[id];
                div.innerHTML += `<div class="bg-white p-3 border rounded shadow-sm flex justify-between text-sm">
                    <span>${m.name} ($${m.unitPrice.toFixed(2)}/${m.unit})</span>
                    <button onclick="del('inventory','${id}')" class="text-red-300 font-bold">×</button></div>`;
                
                // 配方材料勾選區域
                builder.innerHTML += `
                    <div class="flex items-center gap-3 text-sm bg-white p-2 rounded border border-gray-100">
                        <input type="checkbox" class="m-check w-4 h-4" value="${id}">
                        <span class="w-24 font-medium overflow-hidden whitespace-nowrap">${m.name}</span>
                        <div class="flex items-center gap-1">
                            <input type="number" class="m-qty w-20 border rounded px-2 py-1 text-right" placeholder="用量">
                            <span class="text-gray-400 text-xs">${m.unit}</span>
                        </div>
                    </div>`;
            });
        });

        db.ref('items').on('value', snap => {
            const div = document.getElementById('list_items');
            const sel = document.getElementById('order_item_sel');
            div.innerHTML = ""; sel.innerHTML = '<option value="">請選擇產品</option>';
            products = snap.val() || {};
            Object.keys(products).forEach(id => {
                const p = products[id];
                div.innerHTML += `<div class="card !p-4 flex justify-between items-center">
                    <div><b class="text-[#8E9775]">[${p.category}] ${p.name}</b><br>
                    <small class="text-gray-400">售價: $${p.price} | 成本: $${p.totalCost.toFixed(1)} | 利潤: $${p.profit.toFixed(1)}</small></div>
                    <button onclick="del('items','${id}')" class="text-red-300 text-sm">刪除</button></div>`;
                sel.innerHTML += `<option value="${id}">${p.category} - ${p.name}</option>`;
            });
        });

        db.ref('orders').on('value', snap => {
            const orderDiv = document.getElementById('list_orders');
            const statsSum = document.getElementById('stats_summary');
            const statsTable = document.getElementById('stats_table');
            const custDiv = document.getElementById('list_customers');
            orderDiv.innerHTML = ""; statsTable.innerHTML = ""; custDiv.innerHTML = "";
            const data = snap.val() || {};
            let tRev = 0, tCost = 0, pStats = {}, cStats = {};

            Object.keys(data).sort((a,b) => data[b].date.localeCompare(data[a].date)).forEach(id => {
                const o = data[id];
                tRev += o.price; tCost += (o.cost || 0);
                pStats[o.itemName] = pStats[o.itemName] || { count: 0, profit: 0 };
                pStats[o.itemName].count++; pStats[o.itemName].profit += o.profit;
                if(!cStats[o.cust]) cStats[o.cust] = { total: 0, count: 0, last: o.date };
                cStats[o.cust].total += o.price; cStats[o.cust].count++; if(o.date > cStats[o.cust].last) cStats[o.cust].last = o.date;

                orderDiv.innerHTML += `<div class="card !p-3 border-l-4 border-[#8E9775] flex justify-between">
                    <div><b>${o.cust}</b> <small class="text-gray-400">${o.source}</small><p class="text-xs text-gray-500">${o.itemName} ($${o.price}) - ${o.date}</p></div>
                    <div class="text-right">
                        <select onchange="db.ref('orders/${id}').update({status:this.value})" class="text-[10px] w-20">
                            <option value="製作中" ${o.status=='製作中'?'selected':''}>製作中</option>
                            <option value="已出貨" ${o.status=='已出貨'?'selected':''}>已出貨</option>
                            <option value="已完成" ${o.status=='已完成'?'selected':''}>已完成</option>
                        </select><br><button onclick="del('orders','${id}')" class="text-red-200 text-[10px] mt-1">刪除</button>
                    </div></div>`;
            });
            statsSum.innerHTML = `<div class="card text-center"><h6>總營收</h6><b class="text-xl">$${tRev}</b></div><div class="card text-center text-red-400"><h6>總成本</h6><b class="text-xl">$${tCost.toFixed(0)}</b></div><div class="card text-center text-green-600"><h6>總利潤</h6><b class="text-xl">$${(tRev-tCost).toFixed(0)}</b></div>`;
            Object.keys(pStats).forEach(n => { statsTable.innerHTML += `<tr class="border-b"><td>${n}</td><td>${pStats[n].count}</td><td class="text-green-600">$${pStats[n].profit.toFixed(0)}</td></tr>`; });
            Object.keys(cStats).forEach(c => { custDiv.innerHTML += `<div class="card"><b>${c}</b><div class="text-[#8E9775] font-bold text-lg">$${cStats[c].total}</div><p class="text-[10px] text-gray-400">購買：${cStats[c].count}次 | 最後：${cStats[c].last}</p></div>`; });
        });

        function del(path, id) { if(confirm("確定要刪除嗎？")) db.ref(path + '/' + id).remove(); }
        window.onload = () => showTab('orders');
    </script>
</body>
</html>
