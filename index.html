<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>好心手作 HaoXinHandMade | 雲端同步系統</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        body { background-color: #F0F0F0; color: #4A4A4A; font-family: "PingFang TC", "Microsoft JhengHei", sans-serif; }
        .sidebar { transition: all 0.3s ease; width: 300px; min-width: 300px; }
        .sidebar.collapsed { width: 0; min-width: 0; overflow: hidden; padding: 0; margin: 0; border: none; }
        .nav-btn.active { background-color: #8E9775; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card { background: white; border-radius: 1.5rem; padding: 1.8rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 1.2rem; border: 1px solid #EAEAEA; }
        input, select, textarea { border: 1px solid #DDD; border-radius: 0.8rem; padding: 0.6rem; outline: none; width: 100%; transition: border 0.2s; }
        .order-date-text { font-size: 1.5rem; font-weight: 800; color: #555; }
        .order-source-text { font-size: 1.2rem; color: #8E9775; font-weight: 600; background: #F3F5F0; padding: 2px 12px; border-radius: 99px; }
        .warning-orange { color: #F59E0B; font-weight: 800; }
        .warning-red { color: #EF4444; font-weight: 900; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        /* 修正後的遮罩：若同步失敗 5 秒後會自動消失 */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; z-index: 999; font-weight: bold; color: #8E9775; }
    </style>
</head>
<body class="flex min-h-screen">
    <div id="loading-overlay">雲端資料同步中...</div>
    <aside id="sidebar" class="sidebar bg-white border-r h-screen sticky top-0 flex flex-col p-5 shadow-2xl z-50">
        <div class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-2xl font-black text-[#8E9775] tracking-tighter">好心手作</h1>
                <p class="text-[9px] text-gray-400 tracking-[0.2em]">HaoXin HandMade</p>
            </div>
            <button onclick="toggleSidebar()" class="text-gray-300 hover:text-gray-600">✕</button>
        </div>
        <nav class="space-y-3 mb-10">
            <button onclick="switchTab('orders')" id="btn-orders" class="nav-btn active w-full text-left px-5 py-3 rounded-xl font-bold">訂單管理</button>
            <button onclick="switchTab('backend')" id="btn-backend" class="nav-btn w-full text-left px-5 py-3 rounded-xl font-bold">系統後台</button>
            <button onclick="switchTab('customers')" id="btn-customers" class="nav-btn w-full text-left px-5 py-3 rounded-xl font-bold">客戶資料維護</button>
        </nav>
        <div class="border-t pt-6">
            <button onclick="toggleElement('newOrderForm')" class="w-full flex justify-between items-center font-black text-gray-500 hover:text-[#8E9775] mb-5">
                <span>建立新訂單</span><span id="formArrow">▼</span>
            </button>
            <div id="newOrderForm" class="space-y-4 text-sm">
                <input type="date" id="orderDate">
                <select id="pSelect" onchange="syncPrice()"></select>
                <div class="flex gap-2"><input type="number" id="pPrice" placeholder="售價"><button onclick="addToBasket()" class="bg-[#A38A8A] text-white px-4 rounded-xl font-bold">加入</button></div>
                <div id="basketArea" class="hidden bg-gray-50 p-4 rounded-xl border-2 border-dashed border-gray-200">
                    <ul id="basketList" class="text-xs space-y-2 mb-2"></ul>
                    <div class="text-right font-bold text-[#A38A8A] border-t pt-2">小計: $<span id="basketTotal">0</span></div>
                </div>
                <input type="text" id="cName" list="nameHistory" placeholder="客戶姓名">
                <datalist id="nameHistory"></datalist>
                <select id="cSource">
                    <option value="可艾媽社群">可艾媽社群</option>
                    <option value="Instagram">Instagram</option>
                    <option value="Threads">Threads</option>
                    <option value="朋友介紹">朋友介紹</option>
                </select>
                <button onclick="finalizeOrder()" class="w-full bg-[#8E9775] text-white py-4 rounded-2xl font-bold shadow-lg">確認建立訂單</button>
            </div>
        </div>
    </aside>    <main class="main-content flex-1 p-6 md:p-10">
        <button onclick="toggleSidebar()" class="mb-6 bg-white px-5 py-2 rounded-xl shadow-sm font-bold text-gray-400">開啟選單</button>
        <div id="tab-orders" class="tab-content active mx-auto max-w-5xl">
            <div id="displayBoard" class="space-y-6"></div>
        </div>
        <div id="tab-backend" class="tab-content">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-10">
                <div class="card">
                    <h3 class="font-black text-xl mb-6 text-[#8E9775]">分類管理</h3>
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="newCatName" placeholder="輸入新分類名稱">
                        <button onclick="addCategory()" class="bg-gray-500 text-white px-6 rounded-xl font-bold">新增</button>
                    </div>
                    <div id="catList" class="grid grid-cols-2 gap-2"></div>
                </div>
                <div class="card">
                    <h3 class="font-black text-xl mb-6 text-[#8E9775]">材料庫存管理</h3>
                    <div class="grid grid-cols-3 gap-3 mb-4 text-xs">
                        <input type="text" id="matName" placeholder="材料名稱">
                        <input type="number" id="matPrice" placeholder="單價">
                        <input type="number" id="matStock" placeholder="現有庫存">
                    </div>
                    <button onclick="addMaterial()" class="w-full bg-gray-500 text-white py-3 rounded-xl font-bold mb-6">新增材料</button>
                    <table class="w-full text-sm">
                        <thead class="text-left text-gray-400 border-b"><tr><th class="pb-2">材料名稱</th><th class="pb-2 text-center">單價</th><th class="pb-2 text-center">庫存</th><th></th></tr></thead>
                        <tbody id="matTableBody"></tbody>
                    </table>
                </div>
                <div class="card xl:col-span-2">
                    <h3 class="font-black text-xl mb-6 text-[#8E9775]">品項與成本設定</h3>
                    <div id="prodGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>
            </div>
        </div>
        <div id="tab-customers" class="tab-content">
            <div class="card max-w-5xl mx-auto" id="customerListArea"></div>
        </div>
    </main>    <script>
        // --- 1. Firebase 設定 (請務必在此貼上您的專屬代碼) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA9tMo62e3zhf0qR9lgcHE-YMIh5eaZ8dk", // A 必須小寫
            authDomain: "haoxin-44098.firebaseapp.com",
            databaseURL: "https://haoxin-44098-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "haoxin-44098",
            storageBucket: "haoxin-44098.firebasestorage.app",
            messagingSenderId: "878734507134",
            appId: "1:878734507134:web:91598cf6816d401e66ac2f"
        };

        // --- 2. 初始化檢查 ---
        let db = { categories: [], materials: [], products: [], orders: [] };
        let dbRef;

        try {
            firebase.initializeApp(firebaseConfig);
            dbRef = firebase.database().ref('haoxin_cloud_data');
            // 5秒後若還沒同步成功，強制關閉遮罩讓使用者操作
            setTimeout(() => {
                const loader = document.getElementById('loading-overlay');
                if (loader && loader.style.display !== 'none') {
                    loader.style.display = 'none';
                    console.warn("同步超時，切換至本地預覽模式");
                }
            }, 5000);
        } catch (e) {
            alert("Firebase 連線失敗！請檢查 config 代碼是否正確。");
        }

        // --- 3. 雲端同步監聽 ---
        if (dbRef) {
            dbRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    db = data;
                    if (!db.categories) db.categories = [];
                    if (!db.materials) db.materials = [];
                    if (!db.products) db.products = [];
                    if (!db.orders) db.orders = [];
                }
                refreshUI();
                document.getElementById('loading-overlay').style.display = 'none';
            }, (error) => {
                console.error("同步失敗：", error);
                alert("無法從雲端讀取資料，請檢查 Firebase 規則(Rules)是否設定為 true");
            });
        }

        function cloudSave() { 
            if (dbRef) {
                dbRef.set(db).catch(e => alert("儲存失敗：" + e.message));
            } else {
                alert("未連線至雲端");
            }
        }        // --- 4. 核心功能邏輯 ---
        function calculateWorkDaysLeft(orderDateStr) {
            const startDate = new Date(orderDateStr);
            let count = 0, targetDate = new Date(startDate);
            while (count < 21) {
                targetDate.setDate(targetDate.getDate() + 1);
                if (targetDate.getDay() !== 0 && targetDate.getDay() !== 6) count++;
            }
            const today = new Date(); today.setHours(0,0,0,0);
            let check = new Date(today), daysLeft = 0;
            if (check > targetDate) {
                while (check > targetDate) { if (targetDate.getDay()!==0 && targetDate.getDay()!==6) daysLeft--; targetDate.setDate(targetDate.getDate()+1); }
            } else {
                while (check < targetDate) { if (check.getDay()!==0 && check.getDay()!==6) daysLeft++; check.setDate(check.getDate()+1); }
            }
            return daysLeft;
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
        function toggleElement(id) { document.getElementById(id).classList.toggle('hidden'); }
        function switchTab(tab) {
            document.querySelectorAll('.tab-content, .nav-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('btn-' + tab).classList.add('active');
        }

        function refreshUI() {
            renderCategories(); renderMaterials(); renderProducts(); renderOrders(); renderCustomerList();
            document.getElementById('pSelect').innerHTML = '<option value="">-- 品項選擇 --</option>' + (db.products || []).map(p=>`<option value="${p.name}">${p.name} ($${p.price})</option>`).join('');
            document.getElementById('nameHistory').innerHTML = [...new Set((db.orders || []).map(o=>o.customer))].map(n=>`<option value="${n}">`).join('');
        }

        function addCategory() { const val = document.getElementById('newCatName').value.trim(); if(val){db.categories.push(val); cloudSave(); document.getElementById('newCatName').value="";} }
        function renderCategories() { document.getElementById('catList').innerHTML = (db.categories || []).map((c, i) => `<div class="flex justify-between bg-gray-100 p-3 rounded-xl font-bold"><span>${c}</span><button onclick="db.categories.splice(${i},1); cloudSave()">✕</button></div>`).join(''); }
        function addMaterial() { const n = document.getElementById('matName').value, p = parseInt(document.getElementById('matPrice').value), s = parseInt(document.getElementById('matStock').value); if(n){db.materials.push({name:n, price:p||0, stock:s||0}); cloudSave();} }
        function renderMaterials() { document.getElementById('matTableBody').innerHTML = (db.materials || []).map((m, i) => `<tr class="border-b"><td class="py-3 font-bold">${m.name}</td><td class="text-center">$${m.price}</td><td class="text-center"><input type="number" onchange="db.materials[${i}].stock=this.value; cloudSave()" value="${m.stock}" class="w-16 bg-transparent text-center"></td><td class="text-right"><button onclick="db.materials.splice(${i},1); cloudSave()">移除</button></td></tr>`).join(''); }
        function renderProducts() {
            document.getElementById('prodGrid').innerHTML = `<div class="card md:col-span-2 bg-gray-50 border-none"><div class="grid grid-cols-1 md:grid-cols-4 gap-4"><input type="text" id="p_name" placeholder="品項名稱"><select id="p_cat">${(db.categories || []).map(c=>`<option value="${c}">${c}</option>`).join('')}</select><input type="number" id="p_price" placeholder="售價"><button onclick="const n=document.getElementById('p_name').value, c=document.getElementById('p_cat').value, p=parseInt(document.getElementById('p_price').value); if(n){db.products.push({name:n,cat:c,price:p,recipe:[]});cloudSave();}" class="bg-[#8E9775] text-white rounded-xl font-bold">新增品項</button></div></div>` + 
            (db.products || []).map((p, pi) => {
                const cost = (p.recipe || []).reduce((s, r) => { const m = db.materials.find(mat=>mat.name===r.name); return s+(m?m.price*r.qty:0); }, 0);
                return `<div class="card"><div class="flex justify-between font-black text-xl"><span>${p.name} <small class="text-gray-400 text-xs">${p.cat}</small></span><button onclick="db.products.splice(${pi},1); cloudSave()" class="text-xs text-red-200">移除</button></div><div class="flex gap-4 my-3 text-sm"><b>售價 $${p.price}</b><b class="text-[#A38A8A]">成本 $${cost}</b></div><div class="space-y-1 mb-4">${(p.recipe || []).map((r,ri)=>`<div class="flex justify-between text-xs bg-gray-50 p-1"><span>${r.name} x ${r.qty}</span><button onclick="db.products[${pi}].recipe.splice(${ri},1); cloudSave()">✕</button></div>`).join('')}</div><div class="flex gap-1"><select id="rmat-${pi}" class="text-xs">${db.materials.map(m=>`<option value="${m.name}">${m.name}</option>`).join('')}</select><input type="number" id="rqty-${pi}" class="w-12 text-xs" placeholder="量"><button onclick="const m=document.getElementById('rmat-${pi}').value, q=parseInt(document.getElementById('rqty-${pi}').value); if(m&&q){db.products[${pi}].recipe.push({name:m,qty:q});cloudSave();}" class="bg-gray-200 px-2 rounded font-bold text-xs">加</button></div></div>`;
            }).join('');
        }

        let basket = [];
        function syncPrice() { const p = db.products.find(x=>x.name===document.getElementById('pSelect').value); document.getElementById('pPrice').value = p ? p.price : ""; }
        function addToBasket() { const n = document.getElementById('pSelect').value, p = parseInt(document.getElementById('pPrice').value); if(n){basket.push({name:n, price:p}); document.getElementById('basketArea').classList.remove('hidden'); document.getElementById('basketList').innerHTML=basket.map(b=>`<li>- ${b.name}</li>`).join(''); document.getElementById('basketTotal').innerText=basket.reduce((s,i)=>s+i.price,0);} }
        function finalizeOrder() {
            const name = document.getElementById('cName').value.trim(), src = document.getElementById('cSource').value, date = document.getElementById('orderDate').value;
            if(!name || basket.length === 0) return alert("資料不完整");
            basket.forEach(item => { const prod = db.products.find(p=>p.name===item.name); if(prod) (prod.recipe || []).forEach(r => { const m = db.materials.find(mat=>mat.name===r.name); if(m) m.stock -= r.qty; }); });
            db.orders.unshift({ id: Date.now(), date, customer: name, source: src, items: [...basket], total: basket.reduce((s,i)=>s+i.price,0), status: 'pending' });
            basket = []; document.getElementById('basketArea').classList.add('hidden'); document.getElementById('cName').value=""; cloudSave();
        }
        function renderOrders() {
            document.getElementById('displayBoard').innerHTML = (db.orders || []).map(o => {
                const days = calculateWorkDaysLeft(o.date);
                let warn = ""; if(o.status!=='completed'){ if(days<=5) warn="warning-red"; else if(days<=10) warn="warning-orange"; }
                return `<div class="card"><div class="flex justify-between items-start" onclick="this.nextElementSibling.classList.toggle('hidden')"><div><div class="flex gap-4 items-center"><span class="order-date-text">${o.date}</span><span class="order-source-text">${o.source}</span></div><div class="text-4xl font-black my-2">${o.customer}</div><button onclick="event.stopPropagation(); const flow=['pending','shipped','completed']; let n=flow.indexOf(o.status)+1; o.status=flow[n>=3?0:n]; cloudSave();" class="bg-gray-100 px-4 py-1 rounded-full text-xs font-bold">${o.status}</button></div><div class="text-right"><div class="text-5xl font-black ${warn}">${o.status==='completed'?'DONE':days+'D'}</div><div class="text-2xl font-black text-[#8E9775] mt-2">$${o.total}</div></div></div><div class="hidden mt-4 pt-4 border-t border-dashed">${(o.items || []).map(i=>`<div class="flex justify-between text-sm"><span>${i.name}</span><span>$${i.price}</span></div>`).join('')}<button onclick="if(confirm('刪除？')){db.orders=db.orders.filter(x=>x.id!==${o.id});cloudSave();}" class="text-[10px] text-gray-300 mt-4">刪除此單</button></div></div>`;
            }).join('');
        }
        function renderCustomerList() {
            const sum = {}; (db.orders || []).forEach(o => { if(!sum[o.customer]) sum[o.customer]={c:0, t:0}; sum[o.customer].c++; sum[o.customer].t+=o.total; });
            document.getElementById('customerListArea').innerHTML = `<h3 class="font-black text-2xl mb-8 text-[#8E9775]">客戶資料維護</h3><table class="w-full text-left"><thead><tr class="text-gray-400 border-b"><th class="pb-4">名稱</th><th class="pb-4 text-center">次數</th><th class="pb-4 text-right">累積金額</th></tr></thead><tbody>${Object.keys(sum).sort((a,b)=>sum[b].t-sum[a].t).map(n => `<tr class="border-b"><td class="py-6 font-black text-xl">${n}</td><td class="text-center">${sum[n].c}</td><td class="text-right text-[#8E9775] font-black">$${sum[n].t}</td></tr>`).join('')}</tbody></table>`;
        }
        window.onload = () => { document.getElementById('orderDate').valueAsDate = new Date(); };
    </script>
</body>
</html>